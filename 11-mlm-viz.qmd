```{r include=FALSE}
source("R/common.R")
knitr::opts_chunk$set(fig.path = "figs/ch11/")
```

::: {.content-visible unless-format="pdf"}
{{< include latex/latex-commands.qmd >}}
:::

# Visualizing Multivariate Models {#sec-vis-mlm}

Tests of multivariate models, including multivariate analysis of variance (MANOVA) for group differences and multivariate multiple regression (MMRA) can be easily visualized by plots of a hypothesis ("H") data ellipse for the fitted values relative to the corresponding plot of the error ellipse ("E") of the residuals, which I call the HE plot framework.

For more than a few response variables, these result can be projected onto a lower-dimensional "canonical discriminant" space providing an even simpler description.


**Packages**

In this chapter we use the following packages. Load them now
```{r}
library(car)
library(heplots)
library(ggplot2)
library(dplyr)
library(tidyr)
```

## HE plot framework {#sec-he-framework}

@sec-Hotelling illustrated the basic ideas of the framework for visualizing multivariate
linear models in the context of a simple two group design, using Hotelling's $T^2$.  The main ideas were illustrated in @fig-HE-framework.

Having described the statistical ideas behind the MLM in @sec-mlm-review, we can proceed to
extend this framework to larger designs. @fig-dogfood-quartet illustrates these ideas using the
simple one-way MANOVA design of the dogfood data from @sec-dogfood-data.

```{r}
#| label: fig-dogfood-quartet
#| echo: false
#| fig-align: center
#| out-width: "100%"
#| fig-cap: "**Dogfood quartet**: Illustration of the conceptual ideas of the HE plot framework for the dogfood data. (a) Scatterplot of the data; (b) Summary using data ellipses; (c) HE plot shows the variation in the means in relation to pooled within group variance; (d) Transformation from data space to canonical space"
knitr::include_graphics("images/dogfood-quartet.png")
```



* In data space (a), each group is summarized by its **data ellipse** (b), representing the means and covariances.

* Variation against the hypothesis of equal means can be seen by the $\mathbf{H}$ ellipse in the **HE plot** (c), representing the data ellipse of the fitted values. Error variance is shown in the $\mathbf{E}$ ellipse,
representing the pooled within-group covariance matrix, $\mathbf{S}_p$ and the data ellipse of the residuals from the model.
For the dogfood data, the group means have a negative relation: longer time to start eating is associated with a smaller amount eaten.

* The MANOVA (or Hotelling's $T^2$) is formally equivalent to a **discriminant analysis**, predicting
group membership from the response variables which can be seen in data space. (The main difference is 
emphasis and goals: MANOVA seeks to test differences among group means, while discriminant analysis aims
at classification of the observations into groups.)

* This effectively projects the $p$-dimensional
space of the predictors into the smaller **canonical space** (d) that shows the greatest differences among
the groups. As in a biplot, vectors show the relations of the response variables with the canonical dimensions.

<!--
```{r}
#| label: fig-HE-framework
#| echo: false
#| fig-align: center
#| out-width: "100%"
#| fig-cap: "The Hypothesis Error plot framework for a two-group design. Above: Data ellipses can be summarized in an HE plot showing the pooled within-group error ($\\mathbf{E}$) ellipse and the $\\mathbf{H}$ 'ellipse' for the group means.
#| Below: Observations projected on the line joining the means give discriminant scores which correpond to a one-dimensional canonical space, represented by a boxplot of their scores and arrows reflecting the variable weights."
knitr::include_graphics("images/HE-framework.png")
```
-->

<!--
Having described the statistical ideas behind the MLM in @sec-mlm-review, we can proceed to
extend this framework to larger designs. A conceptual overview is shown in @fig-arcmanov1 for a one-way MANOVA
design with 8 groups.

```{r}
#| label: fig-arcmanov1
#| echo: false
#| fig-align: center
#| out-width: "100%"
#| fig-cap: "Conceptual plots showing the essential ideas behind multivariate tests, in terms of the hypothesis
#| ($\\mathbf{H}$) and error ($\\mathbf{E}$) matrices for a 1-way MANOVA design with two response variables, $Y_1$ and $Y_2$"
knitr::include_graphics("images/arcmanov.png")
```
-->


For more complex models such as MANOVA with multiple factors or multivariate multivariate regression,
there is one sum of squares and products matrix (SSP), and therefore one
$\mathbf{H}$ ellipse for each term in the model. For example, in a two-way MANOVA design with the model
formula `(y1, y2) ~ A + B + A*B` and equal sample sizes in the groups, the total sum of squares accounted for by the model is
\begin{align*}
\mathbf{SSP}_{\text{Model}} & = \mathbf{SSP}_{A} + \mathbf{SSP}_{B} + \mathbf{SSP}_{AB} \\
                            & = \mathbf{H}_A + \mathbf{H}_B + \mathbf{H}_{AB} \period
\end{align*}


## HE plot construction

The HE plot is constructed to allow a direct visualization of the "size" of hypothesized terms in
a multivariate linear model in relation to unexplained error variation.
These can be displayed in 2D or 3D plots, so I use the term "ellipsoid" below to cover all cases.

Error variation is represented by a standard 68\% data ellipsoid of the $\mat{E}$ matrix
of the residuals in $\Epsilon$. This is divided by the residual degrees of freedom, so the size of $\mat{E} / \text{df}_e$ is analogous to a mean square error
in univariate tests. The choice of 68\% coverage allows you to ``read'' the residual standard deviation as the half-length of the
shadow of the $\mat{E}$ ellipsoid on any axis (see @fig-galton-ellipse-r).
The $\mat{E}$ ellipsoid is then translated to the overall (grand) means $\bar{\mathbf{y}}$ of the variables plotted, which allows us to show the means for factor levels on the same scale, facilitating interpretation.
In the notation of @eq-ellE, the error ellipsoid is given by
$$
\mathcal{E}_c (\bar{\mathbf{y}}, \mathbf{E}) = \bar{\mathbf{y}} \; \oplus \; c\,\mathbf{E}^{1/2} \comma
$$ {#eq-Ec}
where $c = \sqrt{2 F_{2, n-2}^{0.68}}$ for 2D plots and $c = \sqrt{3 F_{3, n-3}^{0.68}}$ for 3D for standard 68% coverage.

An ellipsoid representing variation in the means of a factor (or any other term reflected in a general linear hypothesis test, @eq-hmat) in the $\mat{H}$ matrix is simply the data ellipse of the fitted values for that term. 

Dividing the hypothesis matrix by the error degrees of freedom, giving
$\mat{H} / \text{df}_e$,
puts this on the same scale as the \E ellipse.
<!-- , as shown in the left panel of \figref{fig:heplot-iris1}. -->
I refer to this as _effect size scaling_, because it is similar to an effect size index used in
univariate models, e.g., $ES = (\bar{y}_1 - \bar{y}_2) / s_e$ in a two-group, univariate design.

<!--
The notation $\bar{\mathbf{y}} \; \oplus$ in @eq-Ec means that the error ellipsoid is
shifted to be centered at the grand means of the response variables, where the $\mat{H}$
is also centered. This allows the HE plot to also show the group means, facilitating
interpretation.
-->

### Example: Iris data {#iris-ex}

Perhaps the most famous (or infamous) dataset in the history of multivariate data analysis is that of measurements on three species of Iris flowers collected by Edgar Anderson [-@Anderson:35] in the Gaspé Peninsula of Québec, Canada. 
Anderson wanted to quantify the outward appearance ("morphology": shape, structure, color, pattern, size) of species as a method to study variation within and between such groups. Although Anderson published in the obscure _Bulletin of the American Iris Society_, R. A. Fisher [-@Fisher:1936] saw this as a challenge and opportunity to introduce the method now called
discriminant analysis---how to find a weighted composite of variables to best discriminate among existing groups.

<!-- depending on use, make some of this a text box -->
::: {.callout-note title="History corner"}

I said "infamous" above because Fisher published in the _Annals of Eugenics_, was an ardent eugenicist himself, 
and the work of eugenicists was often pervaded by prejudice against racial, ethnic and disabled groups.
Through guilt by association, the Iris data, having mistakenly been called "Fisher's Iris Data",
has become deprecated, even called "racist data".[^stop-iris] The voices of the _Setosa_, _Versicolor_ and _Virginica_ of
Gaspé protest: we don't have a racist bone in out body and nor prejudice against any
other species.

@Bodmer-etal-2021 present a careful account of Fisher's views on eugenics within the context
of his time and his contributions to modern statistical theory and practice.
Fisher's views on race were largely formed by Darwin and Galton,
but "nearly all of Fisher’s statements were about populations,
groups of populations, or the human species as a whole". Regardless, the `iris` data were
Anderson's and should not be blamed. After all, if Anderson had lent his car to Fisher,
would the car be tainted by Fisher's eugenicist leanings?

[^stop-iris]: [Stop using iris](https://www.meganstodel.com/posts/no-to-iris/)
:::

<!--
```{r}
#| label: fig-iris-flowers
#| out-width: "100%"
#| fig-cap: "Three species of irises in the Anderson/Fisher data set. _Source_: P. I. Adegbite [Iris Flower Classification]( https://peaceadegbite1.medium.com/iris-flower-classification-60790e9718a1)"
knitr::include_graphics(here::here("images/iris-flowers-labeled.png"))
```

@fig-iris-flowers shows photos of the three iris species, _Setosa_, _Versicolor_ and _Virginica_. 
Each flower has three sepals and three petals. The sepals have brightly colored central sections.
Anderson recorded measurements of the  length and width (in cm.) of the sepals and petals on 50 flowers of each type.
-->

```{r}
#| label: fig-iris-diagram
#| echo: false
#| out-width: "70%"
#| fig-cap: "Diagram of an iris flower showing the measurements of petal and sepal size. Each flower has three sepals and three alternating petals. The sepals have brightly colored central sections. _Source_: @DeSilva2020"
knitr::include_graphics(here::here("images/iris-diagram.jpg"))
```

So that we understand what the measurements represent, @fig-iris-diagram superposes labels on a typical iris flower.
Sepals are like ostentatious petals, with attractive decorations in the central section. Length is the distance from the center
to the tip and width is the transverse dimension.

As always, it is useful to start with overview displays to see the data.
A scatterplot matrix (@fig-iris-spm) shows that _versicolor_ and _virginica_ are more
similar to each other than either is to _setosa_, both in their pairwise means (_setosa_ are smaller) and in the
slopes of regression lines.
Further, the ellipses  suggest that the
assumption of constant within-group covariance matrices is problematic: While the shapes and sizes of the concentration ellipses for _versicolor_ and _virginica_ are reasonably similar, the shapes and sizes of the ellipses for _setosa_ are different from the other two.

```{r}
#| label: fig-iris-spm
#| out-width: "100%"
#| fig-width: 10
#| fig-height: 10
#| fig-cap: "Scatterplot matrix of the `iris` dataset. The species are summarized by 68% data ellipses and linear regression lines in each pairwise plot."
iris_colors <-c("blue", "darkgreen", "brown4")
scatterplotMatrix(~ Sepal.Length + Sepal.Width + 
                    Petal.Length + Petal.Width | Species,
  data = iris,
  col = iris_colors,
  pch = 15:17,
  smooth=FALSE,
  regLine = TRUE,
  ellipse=list(levels=0.68, fill.alpha=0.1),
  diagonal = FALSE,
  legend = list(coords = "bottomleft", 
                cex = 1.3, pt.cex = 1.2))
```

### MANOVA model {#sec-iris-mod}
We proceed nevertheless to fit a multivariate one-way ANOVA model to the iris data.
The MANOVA model for these data addresses the question: "Do the means of the `Species` differ significantly for the sepal and petal variables taken together?" 
$$
\mathcal{H}_0 : \mathbf{\mu}_\textrm{setosa} = \mathbf{\mu}_\textrm{versicolor} = \mathbf{\mu}_\textrm{virginica}
$$


Because there are three species, the test involves $s = \min(p, g-1) =2$ degrees of freedom,
and we are entitled to represent this by two 1-df contrasts,  or sub-questions. From the separation among the groups
shown in @fig-iris-spm (or more botanical knowledge), it makes sense to compare:

* Setosa vs. others: $\mathbf{c}_1 = (1,\: -\frac12, \: -\frac12)$
* Versicolor vs. Virginica: : $\mathbf{c}_1 = (0,\: 1, \: -1)$

You can do this by putting these vectors as columns in a matrix and assigning this to the
`contrasts()` of `Species`. It is important to do this _before_ fitting with `lm()`,
because the contrasts in effect determine how the $\mathbf{X}$ matrix is setup, and hence the
names of the coefficients representing `Species`.

```{r}
C <- matrix(c(1,-1/2,-1/2,  
              0,   1,  -1), nrow=3, ncol=2)
contrasts(iris$Species) <- C
contrasts(iris$Species)
```

Now let's fit the model. As you would expect from @fig-iris-spm, the differences among groups are highly significant. 

```{r iris-mod}
iris.mod <- lm(cbind(Sepal.Length, Sepal.Width, Petal.Length, Petal.Width) ~
                 Species, data=iris)
Anova(iris.mod)
```

As a quick follow-up, it is useful to examine the univariate tests for each of the iris
variables, using `heplots::glance()` or `heplots::uniStats()`. It is of interest that
the $R^2$ values are much larger for the petal variables than the sepal length and width.

```{r iris-glance}
glance(iris.mod)
```

But these statistics don't help to understand _how_ the species differ. For this, we turn
to HE plots.

### HE plots

The `heplot()` function takes a `"mlm"` object and produces an HE plot for one pair
of variables specified by the `variables` argument. By default, it plots the first two.

```{r echo=-(1:2)}
#| label: fig-iris-HE1
#| fig-width: 10
#| fig-height: 5
#| fig-show: hold
#| out-width: "100%"
#| fig-cap: "HE plots for the multivariate model `iris.mod`. The left panel shows the plot for the Sepal variables; the right panel plots the Petal variables."
op <- par(mar = c(4, 4, 1, 1) + .5,
          mfrow = c(1, 2))
heplot(iris.mod, 
       cex = 1.5, cex.lab = 1.5,
       fill=TRUE, fill.alpha=c(0.3, 0.1))
heplot(iris.mod, variables = 3:4,
       cex = 1.5, cex.lab = 1.5,
       fill=TRUE, fill.alpha=c(0.3, 0.1))
```

The interpretation of the plots in @fig-iris-HE1 is as follows:

* For the Sepal variables, length and width are positively correlated _within_ species 
(the $\mat{E}$ = "Error" ellipsoid). The means of the groups (the $\mat{H}$ = "Species" ellipsoid), however, are negatively correlated. This plot is the HE plot representation of the data
shown in row 2, column 1 of @fig-iris-spm. It reflects the relative **shape** of the 
iris sepals: shorter and wider for _setosa_ than the other two species.

* For the Petal variables length and width are again positively correlated _within_ species,
but now the means of the groups are positively correlated: longer petals go with wider ones
across species. This reflects the relative **size** of the iris petals.
The analogous data plot appears in row 4, column 3 of @fig-iris-spm.

<!--
**Older stuff**
@fig-iris-HE0 shows two views of the relationship between sepal length and sepal width for the iris data. ...
```{r}
#| eval: false
op <- par(mar = c(4, 4, 1, 1) + .5,
          mfrow = c(1, 2))
col <-c("blue", "darkgreen", "brown")
clr <- c(col, "red")
covEllipses(cbind(Sepal.Length, Sepal.Width) ~ Species, data=iris,
      pooled = TRUE,
      fill=TRUE,
      fill.alpha = 0.1,
      lwd = 3,
      col = clr,
      cex = 1.5, cex.lab = 1.5,
      label.pos = c(3, 1, 3, 0),
      xlim = c(4,8), ylim = c(2,4))

iris.mod <- lm(cbind(Sepal.Length, Sepal.Width, Petal.Length, Petal.Width) ~
                 Species, data=iris)
heplot(iris.mod, size = "effect",
       cex = 1.5, cex.lab = 1.5,
       fill=TRUE, fill.alpha=c(0.3,0.1),
       xlim = c(4,8), ylim = c(2,4))
par(op)
```

```{r}
#| label: fig-iris-HE0
#| out-width: "100%"
#| fig-cap: "Iris data: Data ellipses and HE plot"
knitr::include_graphics("images/iris-HE1.png")
```
-->


## Significance scaling

The geometry of ellipsoids and multivariate tests allow us to go further with another re-scaling of the $\mat{H}$ ellipsoid
that gives a _visual test of significance_ for any term in a MLM.
This is done simply by dividing $\mat{H} / df_e$ further
by the $\alpha$-critical value of the corresponding test statistic to show the strength of evidence against
the null hypothesis.

Among the various multivariate test statistics,
Roy's maximum root test, based on the largest eigenvalue $\lambda_1$ of $\mat{H} \mat{E}^{-1}$,
gives $\mat{H} / (\lambda_\alpha df_e)$
which has the visual property that the
scaled $\mat{H}$ ellipsoid will protrude _somewhere_ outside the standard $\mat{E}$ ellipsoid if and only if
Roy's test is significant at significance level $\alpha$. The critical value $\lambda_\alpha$ for Roy's
test is
$$
\lambda_\alpha = \left(\frac{\text{df}_1}{\text{df}_2}\right) \; F_{\text{df}_1, \text{df}_2}^{1-\alpha} \comma
$$
where $\text{df}_1 = \max(p, \text{df}_h)$ and $\text{df}_2 = \text{df}_h + \text{df}_e - \text{df}_1$.

For these data, the HE plot using
significance scaling is shown in the right panel of @fig-iris-HE2. The left panel is the same as that
shown for sepal width and length in @fig-iris-HE1, but with axis limits to make the two plots
directly comparable.

```{r}
#| label: fig-iris-HE2
#| echo: false
#| out-width: "100%"
#| fig-cap: "HE plots for sepal width and sepal length in the iris dataset. Left: effect scaling of the $\\mathbf{H}$ matrix; right: significance scaling, where protrusion of $\\mathbf{H}$ outside $\\mathbf{E}$ indicates a significant effect by Roy's test."
knitr::include_graphics("images/iris-HE2.png")
```


## Contrasts

As described in @sec-contrasts, tests of linear hypotheses and contrasts represented by the
general linear test $\mathcal{H}_0: \mathbf{C} \;\mathbf{B} = \mathbf{0}$ provide a
powerful way to probe the _specific_ effects represented within the global null hypothesis,
$\mathcal{H}_0: \mathbf{B} = \mathbf{0}$, that all effects are zero.

Because the contrasts $\mathbf{c}_1$ ("Species1") and $\mathbf{c}_2$ ("Species2")  are orthogonal, i.e., 
$\mathbf{c}_1^\top \mathbf{c}_2 = 0$ their tests are statistically independent, and their
$\mathbf{H}$ matrices are additive. They fully decompose the general question of differences
among the groups into two independent questions regarding the contrasts.

$$
\mathbf{H}_\text{Species} = \mathbf{H}_\text{Species1} + \mathbf{H}_\text{Species2}
$$

`car::linearHypothesis()` is the means for testing these statistically, and `heplot()`
provides the way to show these tests visually. Using the contrasts set up in @sec-iris-mod,
$\mathbf{c}_1$, representing the difference between _setosa_ and the other species
is labeled `Species1` and the comparison of _versicolor_ with _virginica_ is `Species2`.
The coefficients for these in $\mathbf{B}$ give the differences in the means.
The line for `(Intercept)` gives grand means of the variables.

```{r iris-mod-coef}
coef(iris.mod)
```

Numerical tests of hypotheses using `linearHypothesis()` can be specified in a very general way

```{r iris-linhyp}
linearHypothesis(iris.mod, "Species1") |> print(SSP=FALSE)
linearHypothesis(iris.mod, "Species2") |> print(SSP=FALSE)
```

In passing, note that the _joint_ test of these contrasts is exactly equivalent to the overall
test of `Species` (results not shown).

```{r}
linearHypothesis(iris.mod, c("Species1", "Species2"))
```

We can show these contrasts in an HE plot by supplying a named list for the `hypotheses` argument ...

```{r}
hyp <- list("S:Vv"="Species1","V:v"="Species2")
heplot(iris.mod, hypotheses=hyp,
       cex = 1.5, cex.lab = 1.5,
       fill=TRUE, fill.alpha=c(0.3,0.1),
       col = c("red", "blue", "darkgreen", "darkgreen"),
       lty=c(0,0,1,1), label.pos=c(3, 1, 2, 1),
       xlim = c(2, 10), ylim = c(1.4, 4.6))
```


## HE plot matrices

In base R graphics, 2D scatterplots are extended to all pairwise views of multivariate data
with a `pairs()` method. For multivariate linear models, the `r pkg("heplots")` defines a
`pairs.mlm()` method to display HE plots for all pairs of the response variables.



## Canonical discriminant analysis {#sec-candisc}

```{r}
#| echo: false
cat("Writing packages to ", .pkg_file, "\n")
write_pkgs(file = .pkg_file)
```
