```{r include=FALSE}
source("R/common.R")
knitr::opts_chunk$set(fig.path = "figs/ch11/")
```

::: {.content-visible unless-format="pdf"}
{{< include latex/latex-commands.qmd >}}
:::

# Visualizing Multivariate Models {#sec-vis-mlm}

Tests of multivariate models, including multivariate analysis of variance (MANOVA) for group differences and multivariate multiple regression (MMRA) can be easily visualized by plots of a hypothesis ("H") data ellipse for the fitted values relative to the corresponding plot of the error ellipse ("E") of the residuals, which I call the HE plot framework.

For more than a few response variables, these result can be projected onto a lower-dimensional "canonical discriminant" space providing an even simpler description.


**Packages**

In this chapter we use the following packages. Load them now
```{r}
library(car)
library(heplots)
library(ggplot2)
library(dplyr)
library(tidyr)
```

## HE plot framework {#sec-he-framework}

@sec-Hotelling illustrated the basic ideas of the framework for visualizing multivariate
linear models in the context of a simple two group design, using Hotelling's $T^2$.  The main ideas were illustrated in @fig-HE-framework.

Having described the statistical ideas behind the MLM in @sec-mlm-review, we can proceed to
extend this framework to larger designs. @fig-dogfood-quartet illustrates these ideas using the
simple one-way MANOVA design of the dogfood data from @sec-dogfood-data.

```{r}
#| label: fig-dogfood-quartet
#| echo: false
#| fig-align: center
#| out-width: "100%"
#| fig-cap: "**Dogfood quartet**: Illustration of the conceptual ideas of the HE plot framework for the dogfood data. (a) Scatterplot of the data; (b) Summary using data ellipses; (c) HE plot shows the variation in the means in relation to pooled within group variance; (d) Transformation from data space to canonical space"
knitr::include_graphics("images/dogfood-quartet.png")
```



* In data space, each group is summarized by its **data ellipse**, representing the means and covariances.

* Variation against the hypothesis of equal means can be seen by the $\mathbf{H}$ ellipse in the **HE plot**, representing the data ellipse of the fitted values. Error variance is shown in the $\mathbf{E}$ ellipse,
representing the pooled within-group covariance matrix, $\mathbf{S}_p$ and the data ellipse of the residuals from the model.

* The MANOVA (or Hotelling's $T^2$) is formally equivalent to a **discriminant analysis**, predicting
group membership from the response variables which can be seen in data space. (The main difference is 
emphasis and goals: MANOVA seeks to test differences among group means, while discriminant analysis aims
at classification of the observations into groups.)

* This effectively projects the $p$-dimensional
space of the predictors into the smaller **canonical space** that shows the greatest differences among
the groups.

<!--
```{r}
#| label: fig-HE-framework
#| echo: false
#| fig-align: center
#| out-width: "100%"
#| fig-cap: "The Hypothesis Error plot framework for a two-group design. Above: Data ellipses can be summarized in an HE plot showing the pooled within-group error ($\\mathbf{E}$) ellipse and the $\\mathbf{H}$ 'ellipse' for the group means.
#| Below: Observations projected on the line joining the means give discriminant scores which correpond to a one-dimensional canonical space, represented by a boxplot of their scores and arrows reflecting the variable weights."
knitr::include_graphics("images/HE-framework.png")
```
-->

<!--
Having described the statistical ideas behind the MLM in @sec-mlm-review, we can proceed to
extend this framework to larger designs. A conceptual overview is shown in @fig-arcmanov1 for a one-way MANOVA
design with 8 groups.

```{r}
#| label: fig-arcmanov1
#| echo: false
#| fig-align: center
#| out-width: "100%"
#| fig-cap: "Conceptual plots showing the essential ideas behind multivariate tests, in terms of the hypothesis
#| ($\\mathbf{H}$) and error ($\\mathbf{E}$) matrices for a 1-way MANOVA design with two response variables, $Y_1$ and $Y_2$"
knitr::include_graphics("images/arcmanov.png")
```
-->


For more complex models such as MANOVA with multiple factors or multivariate multivariate regression,
there is one $\mathbf{H}$ ellipse for each term in the model. ...

## HE plot construction

The HE plot is constructed to allow a direct visualization of the "size" of hypothesized terms in
a multivariate linear model in relation to unexplained error variation.
These can be displayed in 2D or 3D plots, so I use the term "ellipsoid" below to cover all cases.

Error variation is represented by a standard 68\% data ellipsoid of the $\mat{E}$ matrix
of the residuals in $\Epsilon$. This is divided by the residual degrees of freedom, so the size of $\mat{E} / \text{df}_e$ is analogous to a mean square error
in univariate tests. The choice of 68\% coverage allows you to ``read'' the residual standard deviation as the half-length of the
shadow of the $\mat{E}$ ellipsoid on any axis (see @fig-galton-ellipse-r).
The $\mat{E}$ ellipsoid is then translated to the overall (grand) means $\bar{\mathbf{y}}$ of the variables plotted, which allows us to show the means for factor levels on the same scale, facilitating interpretation.
In the notation of @eq-ellE, the error ellipsoid is given by
$$
\mathcal{E}_c (\bar{\mathbf{y}}, \mathbf{E}) = \bar{\mathbf{y}} \oplus \mathbf{E}^{1/2} \comma
$$
where, for 2D plots $c = \sqrt{2 F_{2, n-2}^{0.68}}$.

An ellipsoid representing variation in the means of a factor (or any other term reflected in a general linear hypothesis test, @eq-hmat) in the $\mat{H}$ matrix is simply the data ellipse of the fitted values for that term. 
Dividing the hypothesis matrix by the error degrees of freedom, giving
$\mat{H} / \text{df}_e$,
puts this on the same scale as the \E ellipse.
<!-- , as shown in the left panel of \figref{fig:heplot-iris1}. -->
I refer to this as _effect size scaling_, because it is similar to an effect size index used in
univariate models, e.g., $ES = (\bar{y}_1 - \bar{y}_2) / s_e$ in a two-group, univariate design.

The geometry of ellipsoids and multivariate tests allow us to go further with a re-scaling of the $\mat{H}$ ellipsoid
that gives a \emph{visual test of significance} for any term in a MLM, simply by dividing $\mat{H} / \text{df}_e$ further
by the $\alpha$-critical value of the corresponding test statistic.
Among the various multivariate test statistics,
Roy's maximum root test gives $\mat{H} / (\lambda_\alpha \text{df}_e)$
which has the visual property that the
scaled $\mat{H}$ ellipsoid will protrude _somewhere_ outside the standard $\mat{E}$ ellipsoid if and only if
Roy's test is significant at significance level $\alpha$. For these data, the HE plot using
significance scaling is shown in the right panel of \figref{fig:heplot-iris1}.



## Canonical discriminant analysis {#sec-candisc}

```{r}
#| echo: false
cat("Writing packages to ", .pkg_file, "\n")
write_pkgs(file = .pkg_file)
```
