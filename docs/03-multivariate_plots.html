<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Visualizing Multivariate Data and Models in R - 3&nbsp; Plots of Multivariate Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04-pca-biplot.html" rel="next">
<link href="./02-getting_started.html" rel="prev">
<link href="./images/favicon/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-multivariate_plots.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Plots of Multivariate Data</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Visualizing Multivariate Data and Models in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/friendly/vis-MLM-book" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-multivariate_plots.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Plots of Multivariate Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-pca-biplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">PCA and Biplots</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./linear_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Overview of Linear models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./linear_models-plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Plots for univariate response models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collinearity-ridge.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Collinearity &amp; Ridge Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hotelling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hotelling’s <span class="math inline">\(T^2\)</span></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mlm-viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Visualizing Multivariate Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mlm-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Brief review of the multivariate linear model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./case-studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Case studies</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./eqcov.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Visualizing Tests for Equality of Covariance Matrices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./90-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-bivariate_summaries" id="toc-sec-bivariate_summaries" class="nav-link active" data-scroll-target="#sec-bivariate_summaries"><span class="header-section-number">3.1</span> Bivariate summaries</a>
  <ul class="collapse">
<li><a href="#smoothers" id="toc-smoothers" class="nav-link" data-scroll-target="#smoothers"><span class="header-section-number">3.1.1</span> Smoothers</a></li>
  <li><a href="#stratifiers" id="toc-stratifiers" class="nav-link" data-scroll-target="#stratifiers"><span class="header-section-number">3.1.2</span> Stratifiers</a></li>
  <li><a href="#conditioning" id="toc-conditioning" class="nav-link" data-scroll-target="#conditioning"><span class="header-section-number">3.1.3</span> Conditioning</a></li>
  <li><a href="#sec-data-ellipse" id="toc-sec-data-ellipse" class="nav-link" data-scroll-target="#sec-data-ellipse"><span class="header-section-number">3.1.4</span> Data Ellipses</a></li>
  </ul>
</li>
  <li>
<a href="#sec-scatmat" id="toc-sec-scatmat" class="nav-link" data-scroll-target="#sec-scatmat"><span class="header-section-number">3.2</span> Scatterplot matrices</a>
  <ul class="collapse">
<li><a href="#generalized-pairs-plots" id="toc-generalized-pairs-plots" class="nav-link" data-scroll-target="#generalized-pairs-plots"><span class="header-section-number">3.2.1</span> Generalized pairs plots</a></li>
  </ul>
</li>
  <li><a href="#sec-parcoord" id="toc-sec-parcoord" class="nav-link" data-scroll-target="#sec-parcoord"><span class="header-section-number">3.3</span> Parallel coordinate plots</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-multivariate_plots" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Plots of Multivariate Data</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><blockquote class="blockquote">
<p>There is no excuse for failing to plot and look. — J. W.Tukey (1997), <em>Exploratory Data Analysis</em>, p.&nbsp;157</p>
</blockquote>
<p>The quote above from John Tukey reminds us that data analysis should rightly start with graphs to help us understand the main features of our data, to see patterns, trends and anomalies. This chapter introduces a toolbox of basic graphical methods for visualizing multivariate datasets. It starts with some simple techniques to enhance the basic scatterplot with annotations such as fitted lines, curves and data ellipses to summarize the relation between two variables.</p>
<p>To visualize more than two variables, we can view all pairs of variables in a scatterplot matrix or shift gears entirely to show multiple variables along a set of parallel axes. As the number of variables increase, we may need to suppress details with stronger summaries for a high-level reconnaissance of our data terrain, as we do by zooming out on a map.</p>
<!-- Topics (just for reference) -->
<!-- -   Bivariate summaries -->
<!--     -   smoothers -->
<!--     -   data ellipses -->
<!-- -   Quantitative data: -->
<!--     -   scatterplot matrices -->
<!--     -   parallel coordinate plots -->
<!-- -   ~~Categorical data:~~ -->
<!--     -   ~~mosaic plots~~ -->
<!-- -   Generalized pair plots -->
<p><strong>Packages</strong></p>
<p>In this chapter we use the following packages. Load them now:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/car/">car</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kwstat.github.io/corrgram/">corrgram</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggobi.github.io/ggally/">GGally</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sec-bivariate_summaries" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="sec-bivariate_summaries">
<span class="header-section-number">3.1</span> Bivariate summaries</h2>
<p>The basic scatterplot is the workhorse of multivariate data visualization, showing how one variable, <span class="math inline">\(y\)</span>, often an outcome to be explained by or varies with another, <span class="math inline">\(x\)</span>. It is a building block for many useful techniques, so it is helpful to understand how it can be used as a tool for thinking in a wider, multivariate context.</p>
<p>An essential idea is that we can start with a simple version and add plot annotations to show interesting features more clearly. We consider the following here:</p>
<ul>
<li>
<strong>smoothers</strong>: showing overall trends, perhaps in several forms, as visual summaries;</li>
<li>
<strong>stratifiers</strong>: using color, shape or other features to identify subgroups; more generally, <em>conditioning</em> on other variables;</li>
<li>
<strong>data ellipses</strong>: a compact visual summary of linear relations and uncertainty.</li>
</ul>
<p>Let’s start with data on the academic salaries of faculty members collected at a U.S. college for the purpose of assessing salary differences between male and female faculty members, and perhaps address anomalies in compensation. The dataset <code><a href="https://rdrr.io/pkg/carData/man/Salaries.html">carData::Salaries</a></code> gives data on nine-month salaries and other variables for 397 faculty members in the 2008-2009 academic year.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Salaries</span>, package <span class="op">=</span> <span class="st">"carData"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">Salaries</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    397 obs. of  6 variables:</span></span>
<span><span class="co">#&gt;  $ rank         : Factor w/ 3 levels "AsstProf","AssocProf",..: 3 3 1 3 3 2 3 3 3 3 ...</span></span>
<span><span class="co">#&gt;  $ discipline   : Factor w/ 2 levels "A","B": 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">#&gt;  $ yrs.since.phd: int  19 20 4 45 40 6 30 45 21 18 ...</span></span>
<span><span class="co">#&gt;  $ yrs.service  : int  18 16 3 39 41 6 23 45 20 18 ...</span></span>
<span><span class="co">#&gt;  $ sex          : Factor w/ 2 levels "Female","Male": 2 2 2 2 2 2 2 2 2 1 ...</span></span>
<span><span class="co">#&gt;  $ salary       : int  139750 173200 79750 115000 141500 97000 175000 147765 119250 129000 ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The most obvious predictor of <code>salary</code> is <code>years.since.phd</code>; for simplicity, I’ll refer to this as years of “experience”. Before looking at differences between males and females, we would want consider faculty <code>rank</code> (related also to <code>yrs.service</code>) and <code>discipline</code>, recorded here as <code>A</code> (“theoretical” departments) or <code>B</code> (“applied” departments).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">gg1</span> <span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Salaries</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">yrs.since.phd</span>, y <span class="op">=</span> <span class="va">salary</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar_format</a></span><span class="op">(</span></span>
<span>    prefix<span class="op">=</span><span class="st">"$"</span>, scale <span class="op">=</span> <span class="fl">0.001</span>, suffix <span class="op">=</span> <span class="st">"K"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Years since PhD"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Salary"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> </span>
<span><span class="va">gg1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Salaries-scat" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-scat-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.1: Scatterplot of Salary vs.&nbsp;years since PhD.</figcaption></figure>
</div>
</div>
</div>
<p>There is quite a lot we can see “just by looking” at this simple plot, but the main things are:</p>
<ul>
<li>salary increases generally from 0 - 40 years since the PhD;</li>
<li>variability in salary increases among those with the same experience, a “fan-shaped” pattern that signals a violation of homogeneity of variance in simple regression;</li>
<li>data beyond 50 years is thin, but there are some quite low salaries there.</li>
</ul>
<section id="smoothers" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="smoothers">
<span class="header-section-number">3.1.1</span> Smoothers</h3>
<p>Smoothers are among the most useful graphical annotations you can add to such plots, giving a visual summary of how <span class="math inline">\(y\)</span> changes with <span class="math inline">\(x\)</span>. The most common is to add a line showing the linear regression predictor for <span class="math inline">\(y\)</span> given <span class="math inline">\(x\)</span>, expressed in math notation as <span class="math inline">\(\mathbb{E} (y | x) = b_0 + b_1 x\)</span>. If there is doubt that a linear relation is an adequate summary, you can try a quadratic or other polynomial smoother.</p>
<p>In <strong>ggplot2</strong>, these are easily added to a plot using <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth()</a></code> with <code>method = "lm"</code>, and a model <code>formula</code>, which (by default) is <code>y ~ x</code> for a linear relation or <code>y ~ poly(x, k)</code> for a polynomial of degree <span class="math inline">\(k\)</span>.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gg1</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"red"</span>, fill<span class="op">=</span> <span class="st">"red"</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="st">"y ~ poly(x,2)"</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"darkgreen"</span>, fill <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Salaries-lm" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-lm-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.2: Scatterplot of Salary vs.&nbsp;years since PhD, showing linear and quadratic smooths with 95% confidence bands.</figcaption></figure>
</div>
</div>
</div>
<p>This serves to highlight some of our impressions from the basic scatterplot shown in <a href="#fig-Salaries-scat">Figure&nbsp;<span>3.1</span></a>, making them more apparent. And that’s precisely the point: The regression smoother draws attention to a possible pattern that we can consider as a visual summary of the data. You can think of this as showing what a linear (or quadratic) regression “sees” in the data. Statistical tests (secref?) can help you decide if there is more evidence for a quadratic fit compared to the simpler linear relation.</p>
<p>It is useful to also show some indication of <em>uncertainty</em> (or inversely, <em>precision</em>) associated with with the predicted values. Both the linear and quadratic trends are shown in <a href="#fig-Salaries-lm">Figure&nbsp;<span>3.2</span></a> with 95% pointwise confidence bands. These are necessarily narrower in the center of the range of <span class="math inline">\(x\)</span> where there is typically more data; they get wider toward the highest values of experience where the data are thin.</p>
<section id="non-parametric-smoothers" class="level4 nonumber" data-number="3.1.1.1"><h4 class="nonumber anchored" data-number="3.1.1.1" data-anchor-id="non-parametric-smoothers">
<span class="header-section-number">3.1.1.1</span> Non-parametric smoothers</h4>
<p>The most generally useful idea is a smoother that tracks an average value, <span class="math inline">\(\mathbb{E} (y | x)\)</span>, of <span class="math inline">\(y\)</span> as <span class="math inline">\(x\)</span> varies across its’ range <em>without</em> assuming any particular functional form, and so avoiding the necessity to choose among <code>y ~ poly(x, 1)</code>, or <code>y ~ poly(x, 2)</code>, or <code>y ~ poly(x, 3)</code> …</p>
<p>Non-parametric smoothers attempt to estimate <span class="math inline">\(\mathbb{E} (y | x) = f(x)\)</span> where <span class="math inline">\(f(x)\)</span> is some smooth function. These typically use a collection of weighted <em>local regressions</em> for each <span class="math inline">\(x_i\)</span> within a window centered at that value. In the method called <em>lowess</em> or <em>loess</em> <span class="citation" data-cites="Cleveland:79 ClevelandDevlin:88">(<a href="90-references.html#ref-Cleveland:79" role="doc-biblioref">Cleveland 1979</a>; <a href="90-references.html#ref-ClevelandDevlin:88" role="doc-biblioref">Cleveland and Devlin 1988</a>)</span>, a weight function is applied, giving greatest weight to <span class="math inline">\(x_i\)</span> and weights of 0 outside a window containing a fraction <span class="math inline">\(s\)</span> of the nearest neighbors of <span class="math inline">\(x_i\)</span>. The fraction, <span class="math inline">\(s\)</span>, usually within the range <span class="math inline">\(1/3 \le s \le 2/3\)</span>, called the <em>span</em>, determines the smoothness of the resulting curve; smaller values produce a wigglier curve and larger values giving a smoother fit. If desired, an optimal span can be determined by <span class="math inline">\(k\)</span>-fold cross-validation to minimize a measure of overall error of approximation.</p>
<p>Non-parametric regression is broad topic; see <span class="citation" data-cites="Fox:2016:ARA">Fox (<a href="90-references.html#ref-Fox:2016:ARA" role="doc-biblioref">2016</a>)</span>, Ch. 18 for a more general treatment and <span class="citation" data-cites="Wood:2006">Wood (<a href="90-references.html#ref-Wood:2006" role="doc-biblioref">2006</a>)</span> for generalized additive models, fit using <code>method = "gam"</code> in ggplot2, which is the default when the largest group has more than 1,000 observations.</p>
<p><a href="#fig-Salaries-loess">Figure&nbsp;<span>3.3</span></a> shows the addition of a loess smooth to the plot in <a href="#fig-Salaries-lm">Figure&nbsp;<span>3.2</span></a>, suppressing the confidence band for the linear regression. The loess fit is nearly coincident with the quadratic fit, but has a slightly wider confidence band.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gg1</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/muted.html">muted</a></span><span class="op">(</span><span class="st">"blue"</span><span class="op">)</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="st">"y ~ poly(x,2)"</span>, </span>
<span>              color <span class="op">=</span> <span class="st">"darkgreen"</span>, fill <span class="op">=</span> <span class="st">"lightgreen"</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Salaries-loess" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-loess-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.3: Scatterplot of Salary vs.&nbsp;years since PhD, adding the loess smooth.</figcaption></figure>
</div>
</div>
</div>
<p>But now comes an important question: Is it reasonable that academic salary should increase up to about 40 years since the PhD degree and then decline? The predicted salary for someone still working 50 years after earning their degree is about the same as a person at 15 years. What else is going on here?</p>
</section></section><section id="stratifiers" class="level3" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="stratifiers">
<span class="header-section-number">3.1.2</span> Stratifiers</h3>
<p>Very often, we have a main relationship of interest, but various groups in the data are identified by discrete factors (like faculty <code>rank</code> and <code>sex</code>, their type of <code>discipline</code> here), or there are quantitative predictors for which the main relation might vary. In the language of statistical models such effects are <em>interaction</em> terms, as in <code>y ~ group + x + group:x</code>, where the term <code>group:x</code> fits a different slope for each group and the grouping variable is often called a <em>moderator</em> variable. Common moderator variables are ethnicity, health status, social class and level of education. Moderators can also be continuous variables as in <code>y ~ x1 + x2 + x1:x2</code>.</p>
<p>I call these <em>stratifiers</em>, recognizing that we should consider breaking down the overall relation to see whether and how it changes over such “other” variables. Such variables are most often factors, but we can cut a continuous variable into ranges (<em>shingles</em>) and do the same graphically. There are two general stratifying graphical techniques:</p>
<ul>
<li><p><strong>grouping</strong>: Identify subgroups in the data by assigning different visual attributes, such as color, shape, line style, etc. within a single plot. This is quite natural for factors; quantitative predictors can be accommodated by cutting their range into ordered intervals. Two such grouping variables can be Grouping has the advantage that the levels of a grouping variable can be shown within the same plot, facilitating direct comparison.</p></li>
<li><p><strong>conditioning</strong>: Showing subgroups in different plot panels. This has the advantages that relations for the individual groups more easily discerned and one can easily stratify by two (or more) other variables jointly, but visual comparison is more difficult because the eye must scan from one panel to another.</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A bit of history
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recognition of the roles of visual grouping by factors within a panel and conditioning in multi-panel displays was an important advance in the development of modern statistical graphics. It began at A.T.&amp;T. Bell Labs in Murray Hill, NJ in conjunction with the <strong>S</strong> language, the mother of R.</p>
<p>Conditioning displays (originally called <em>coplots</em> <span class="citation" data-cites="ChambersHastie1991">(<a href="90-references.html#ref-ChambersHastie1991" role="doc-biblioref">Chambers and Hastie 1991</a>)</span>) are simply a collection of 1D, 2D or 3D plots separate panels for subsets of the data broken down by one or more factors, or, for quantitative variables, subdivided into a factor with several overlapping intervals (<em>shingles</em>). The first implementation was in <em>Trellis</em> plots <span class="citation" data-cites="Becker:1996:VDC">Becker, Cleveland, and Shyu (<a href="90-references.html#ref-Becker:1996:VDC" role="doc-biblioref">1996</a>)</span>; Cleveland:85.</p>
<p>Trellis displays were extended in the <strong>lattice</strong> package <span class="citation" data-cites="R-lattice">(<a href="90-references.html#ref-R-lattice" role="doc-biblioref">Sarkar 2023</a>)</span>, which offered:</p>
<ul>
<li>a <strong>graphing syntax</strong> similar to that used in statistical model formulas: <code>y ~ x | g</code> conditions the data by the levels of <code>g</code>, with <code>|</code> read as “given”; two or more conditioning are specified as <code>y ~ x | g1 + g2 + ...</code>, with <code>+</code> read as “and”.</li>
<li>
<strong>panel functions</strong> define what is plotted in a given panel. <code>panel.xyplot()</code> is the default for scatterplots, plotting points, but you can add <code>panel.lmline()</code> for regression lines, <code><a href="https://rdrr.io/pkg/latticeExtra/man/panel.smoother.html">latticeExtra::panel.smoother()</a></code> for loess smooths and a wide variety of others.</li>
</ul>
</div>
</div>
<p>The most obvious variable that affects academic salary is <code>rank</code>, because faculty typically get an increase in salary with a promotion that carries through in their future salary. What can we see if we group by <code>rank</code> and fit a separate smoothed curve for each?</p>
<p>In <code>ggplot2</code> thinking, grouping is accomplished simply by adding an aesthetic, such as <code>color = rank</code>. what happens then is that points, lines, smooths and other <code>geom_*()</code> inherit the feature that they are differentiated by color. In the case of <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth()</a></code>, we get a separate fit for each subset of the data, according to <code>rank</code>.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># make some re-useable pieces to avoid repetitions</span></span>
<span><span class="va">scale_salary</span> <span class="op">&lt;-</span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>  labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/dollar_format.html">dollar_format</a></span><span class="op">(</span>prefix<span class="op">=</span><span class="st">"$"</span>, </span>
<span>                                 scale <span class="op">=</span> <span class="fl">0.001</span>, </span>
<span>                                 suffix <span class="op">=</span> <span class="st">"K"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co"># position the legend inside the plot</span></span>
<span><span class="va">legend_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">0.95</span><span class="op">)</span>, </span>
<span>                    legend.justification <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">Salaries</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">yrs.since.phd</span>, y <span class="op">=</span> <span class="va">salary</span>, </span>
<span>           color <span class="op">=</span> <span class="va">rank</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scale_salary</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Years since PhD"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Salary"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">rank</span><span class="op">)</span>,</span>
<span>                  method <span class="op">=</span> <span class="st">"loess"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>, </span>
<span>                  linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="co">#  theme_bw(base_size = 14) +</span></span>
<span>  <span class="va">legend_pos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Salaries-rank" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-rank-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.4: Scatterplot of Salary vs.&nbsp;years since PhD, grouped by rank.</figcaption></figure>
</div>
</div>
</div>
<p>Well, there is a different story here. Salaries generally occupy separate levels, increasing with academic rank. The horizontal extents of the smoothed curves show their ranges. Within each rank there is some initial increase after promotion, and then some tendency to decline with increasing years. But by and large, years since the PhD doesn’t make that much difference, once we’ve taken academic rank into account</p>
<p>What about the <code>discipline</code>, classified, perhaps peculiarly as “theoretical” vs.&nbsp;“applied”, here? The values are just <code>"A"</code> and <code>"B"</code>, so I map these to more meaningful labels before making the plot.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Salaries</span> <span class="op">&lt;-</span> <span class="va">Salaries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>discipline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">discipline</span>, </span>
<span>                             labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A: Theoretical"</span>, <span class="st">"B: Applied"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Salaries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">yrs.since.phd</span>, y <span class="op">=</span> <span class="va">salary</span>, color <span class="op">=</span> <span class="va">discipline</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scale_salary</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">discipline</span> <span class="op">)</span>,</span>
<span>                method <span class="op">=</span> <span class="st">"loess"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>, </span>
<span>                linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Years since PhD"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Salary"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">legend_pos</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Salaries-discipline" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-discipline-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.5: Scatterplot of Salary vs.&nbsp;years since PhD, grouped by discipline.</figcaption></figure>
</div>
</div>
</div>
<p>The story in <a href="#fig-Salaries-discipline">Figure&nbsp;<span>3.5</span></a> is again different. Faculty in applied disciplines on average earn about 10,000$ more per year on average than their theoretical colleagues.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Salaries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">discipline</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">salary</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   discipline        mean</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;            &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 A: Theoretical 108548.</span></span>
<span><span class="co">#&gt; 2 B: Applied     118029.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For both groups, there is an approximately linear relation up to about 30–40 years, but the smoothed curves then diverge, into the region where the data is thin.</p>
</section><section id="conditioning" class="level3" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="conditioning">
<span class="header-section-number">3.1.3</span> Conditioning</h3>
<p>The previous plots use grouping by color to plot the data for different subsets inside the same plot window, making comparison among groups easier, because they can be directly compared along a common vertical scale <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. This gets messy however when there are more than just a few levels, or worse—when there are two (or more) variables for which we want to show separate effects. In such cases, we can plot separate panels using the <code>ggplot2</code> concept of <em>faceting</em>. There are two options: <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> takes one or more conditioning variables and produces a ribbon of plots for each combination of levels; <code>facet_grid(row ~ col)</code> takes two or more conditioning variables and arranges the plots in a 2D array identified by the <code>row</code> and <code>col</code> variables.</p>
<p>Let’s look at salary broken down by the combinations of discipline and rank. Here, I chose to stratify using color by rank within each of panels faceting by discipline. Because there is more going on in this plot, a linear smooth is used to represent the trend.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Salaries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">yrs.since.phd</span>, y <span class="op">=</span> <span class="va">salary</span>, color <span class="op">=</span> <span class="va">rank</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scale_salary</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Years since PhD"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Salary"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">rank</span><span class="op">)</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>, </span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">discipline</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="co">#  theme_bw(base_size = 14) + </span></span>
<span>  <span class="va">legend_pos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Salaries-faceted" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-faceted-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.6: Scatterplot of Salary vs.&nbsp;years since PhD, grouped by rank, with separate panels for discipline.</figcaption></figure>
</div>
</div>
</div>
<p>Once both of these factors are taken into account, there does not seem to be much impact of years of service. Salaries in theoretical disciplines are noticeably greater than those in applied disciplines at all ranks, and there are even greater differences among ranks.</p>
<p>Finally, to shed light on the question that motivated this example— are there anomalous differences in salary for men and women— we can look at differences in salary according to sex, when discipline and rank are taken into account. To do this graphically, condition by both variables, but use <code>facet_grid(discipline ~ rank)</code> to arrange their combinations in a grid whose rows are the levels of <code>discipline</code> and whose columns are those of <code>rank</code>. I want to make the comparison of males and females most direct, so I use <code>color = sex</code> to stratify the panels. The smoothed regression lines and error bands are calculated separately for each combination of discipline, rank and sex.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Salaries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">yrs.since.phd</span>, y <span class="op">=</span> <span class="va">salary</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scale_salary</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Years since PhD"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Salary"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">discipline</span> <span class="op">~</span> <span class="va">rank</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="va">legend_pos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-Salaries-facet-sex" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Salaries-facet-sex-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.7: Scatterplot of Salary vs.&nbsp;years since PhD, grouped by sex, faceted by discipline and rank.</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-data-ellipse" class="level3" data-number="3.1.4"><h3 data-number="3.1.4" class="anchored" data-anchor-id="sec-data-ellipse">
<span class="header-section-number">3.1.4</span> Data Ellipses</h3>
<p>The <em>data ellipse</em> <span class="citation" data-cites="Monette:90">(<a href="90-references.html#ref-Monette:90" role="doc-biblioref">Monette 1990</a>)</span>, or <em>concentration ellipse</em> <span class="citation" data-cites="Dempster:69">(<a href="90-references.html#ref-Dempster:69" role="doc-biblioref">Dempster 1969</a>)</span> is a remarkably simple and effective display for viewing and understanding bivariate relationships in multivariate data. The data ellipse is typically used to add a visual summary to a scatterplot, that shows all together the means, standard deviations, correlation, and slope of the regression line for two variables, perhaps stratified by another variable. Under the classical assumption that the data are bivariate normally distributed, the data ellipse is also a <strong>sufficient</strong> visual summary, in the sense that it captures <strong>all</strong> relevant features of the data. See <span class="citation" data-cites="Friendly-etal:ellipses:2013">Friendly, Monette, and Fox (<a href="90-references.html#ref-Friendly-etal:ellipses:2013" role="doc-biblioref">2013</a>)</span> for a complete discussion of the role of ellipsoids in statistical data visualization.</p>
<p>It is based on the idea that in a bivariate normal distribution, the contours of equal probability form a series of concentric ellipses. If the variables were uncorrelated and had the same variances, these would be circles, and Euclidean distance would measure the distance of each observation from the mean. When the variables are correlated, a different measure, <em>Mahalanobis distance</em> is the proper measure of how far a point is from the mean, taking the correlation into account.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-mahalanobis" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="images/mahalanobis.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.8: 2D data with curves of constant distance from the centroid. The blue solid ellipse shows a contour of constant Mahalanobis distance, taking the correlation into account; the dashed red circle is a contour of equal Euclidean distance. Given the data points, Which of the points <strong>A</strong> and <strong>B</strong> is further from the mean (X)? <em>Source</em>: Re-drawn from <a href="https://ouzhang.rbind.io/2020/11/16/outliers-part4/">Ou Zhang</a></figcaption></figure>
</div>
</div>
</div>
<p>To illustrate, <a href="#fig-mahalanobis">Figure&nbsp;<span>3.8</span></a> shows a scatterplot with labels for two points, “A” and “B”. Which is further from the mean, “X”? A contour of constant Euclidean distance, shown by the red dashed circle, ignores the apparent negative correlation, so point “A” is further. The blue ellipse for Mahalanobis distance takes the correlation into account, so point “B” has a greater distance from the mean.</p>
<p>Mathematically, Euclidean (squared) distance for <span class="math inline">\(p\)</span> variables, <span class="math inline">\(j = 1, 2, \dots , p\)</span>, is just a generalization of the square of a univariate standardized (<span class="math inline">\(z\)</span>) score, <span class="math inline">\(z^2 = [(y - \bar{y}) / s]^2\)</span>,</p>
<p><span class="math display">\[
D_E^2 (\mathbf{y}) = \sum_j^p z_j^2 = \mathbf{z}^T  \mathbf{z} = (\mathbf{y} - \bar{\mathbf{y}})^T \operatorname{diag}(\mathbf{S})^{-1} (\mathbf{y} - \bar{\mathbf{y}}) \; ,
\]</span> where <span class="math inline">\(\mathbf{S}\)</span> is the sample variance-covariance matrix, <span class="math inline">\(\mathbf{S} = ({n-1})^{-1} \sum_{i=1}^n (\mathbf{y}_i - \bar{\mathbf{y}})^T (\mathbf{y}_i - \bar{\mathbf{y}})\)</span>.</p>
<p>Mahalanobis’ distance takes the correlations into account simply by using the covariances as well as the variances, <span class="math display">\[
D_M^2 (\mathbf{y}) = (\mathbf{y} - \bar{\mathbf{y}})^T S^{-1} (\mathbf{y} - \bar{\mathbf{y}}) \; .
\]</span> For <span class="math inline">\(p\)</span> variables, the data <em>ellipsoid</em> <span class="math inline">\(\mathcal{E}_c\)</span> of size <span class="math inline">\(c\)</span> is a <span class="math inline">\(p\)</span>-dimensional ellipse, defined as the set of points <span class="math inline">\(\mathbf{y} = (y_1, y_2, \dots y_p)\)</span> whose squared Mahalanobis distance, <span class="math inline">\(D_M^2 ( \mathbf{y} )\)</span> is less than or equal to <span class="math inline">\(c^2\)</span>.</p>
<p>When <span class="math inline">\(\mathbf{y}\)</span> is (at least approximately) bivariate normal, <span class="math inline">\(D_M^2(\mathbf{y})\)</span> has a large-sample <span class="math inline">\(\chi^2_2\)</span> distribution (<span class="math inline">\(\chi^2\)</span> with 2 df), so taking <span class="math inline">\(c^2 = \chi^2_2 (0.68) = 2.28\)</span> gives a “1 standard deviation bivariate ellipse,” an analog of the standard interval <span class="math inline">\(\bar{y} \pm 1 s\)</span>, while <span class="math inline">\(c^2 = \chi^2_2 (0.95) = 5.99 \approx 6\)</span> gives a data ellipse of 95% coverage.</p>
<section id="properties" class="level4" data-number="3.1.4.1"><h4 data-number="3.1.4.1" class="anchored" data-anchor-id="properties">
<span class="header-section-number">3.1.4.1</span> Properties</h4>
<p>The essential ideas of correlation and regression and their relation to ellipses go back to <span class="citation" data-cites="Galton:1886">Galton (<a href="90-references.html#ref-Galton:1886" role="doc-biblioref">1886</a>)</span>. Galton’s goal was to to predict (or explain) how a heritable trait, <span class="math inline">\(Y\)</span>, (e.g., height) of children was related to that of their parents, <span class="math inline">\(X\)</span>. He made a semi-graphic table of the frequencies of 928 observations of the average height of father and mother versus the height of their child, shown in <a href="#fig-galton-corr">Figure&nbsp;<span>3.9</span></a>. He then drew smoothed contour lines of equal frequencies and had the wonderful visual insight that these formed concentric shapes that were tolerably close to ellipses. He then calculated summaries, <span class="math inline">\(\text{Ave}(Y | X)\)</span>, and, for symmetry, <span class="math inline">\(\text{Ave}(X | Y)\)</span>, and plotted these as lines of means on his diagram. Lo and behold, he had a second visual insight: the lines of means of (<span class="math inline">\(Y | X\)</span>) and (<span class="math inline">\(X | Y\)</span>) corresponded approximately to the loci of horizontal and vertical tangents to the concentric ellipses. To complete the picture, he added lines showing the major and minor axes of the family of ellipses (which turned out to be the principal components) with the result shown in <a href="#fig-galton-corr">Figure&nbsp;<span>3.9</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-galton-corr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="images/galton-corr.jpg" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.9: Galton’s 1886 diagram, showing the relationship of height of children to the average of their parents’ height. The diagram is essentially an overlay of a geometrical interpretation on a bivariate grouped frequency distribution, shown as numbers.</figcaption></figure>
</div>
</div>
</div>
<p>For two variables, <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, the remarkable properties of the data ellipse are illustrated in <a href="#fig-galton-ellipse-r">Figure&nbsp;<span>3.10</span></a>, a modern reconstruction of Galton’s diagram.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-galton-ellipse-r" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="images/galton-ellipse-r.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.10: Sunflower plot of Galton’s data on heights of parents and their children (in.), with 40%, 68% and 95% data ellipses and the regression lines of <span class="math inline">\(y\)</span> on <span class="math inline">\(x\)</span> (black) and <span class="math inline">\(x\)</span> on <span class="math inline">\(y\)</span> (grey).</figcaption></figure>
</div>
</div>
</div>
<ul>
<li><p>The ellipses have the mean vector <span class="math inline">\((\bar{x}, \bar{y})\)</span> as their center.</p></li>
<li><p>The lengths of arms of the central cross show the standard deviations of the variables, which correspond to the shadows of the ellipse covering 40% of the data. These are the bivariate analogs of the standard intervals <span class="math inline">\(\bar{x} \pm 1 s_x\)</span> and <span class="math inline">\(\bar{y} \pm 1 s_y\)</span>.</p></li>
<li><p>More generally, shadows (projections) on the coordinate axes, or any linear combination of them, give any standard interval, <span class="math inline">\(\bar{x} \pm k s_x\)</span> and <span class="math inline">\(\bar{y} \pm k s_y\)</span>. Those with <span class="math inline">\(k=1, 1.5, 2.45\)</span>, have bivariate coverage 40%, 68% and 95% respectively, corresponding to these quantiles of the <span class="math inline">\(\chi^2\)</span> distribution with 2 degrees of freedom, i.e., <span class="math inline">\(\chi^2_2 (.40) \approx 1^2\)</span>, <span class="math inline">\(\chi^2_2 (.68) \approx 1.5^2\)</span>, and <span class="math inline">\(\chi^2_2 (.95) \approx 2.45\)</span>. The shadows of the 68% ellipse are the bivariate analog of a univariate <span class="math inline">\(\bar{x} \pm 1 s_x\)</span> interval. <!-- and univariate coverage 68\%, 87\% and 98.6\% respectively. --></p></li>
<li><p>The regression line predicting <span class="math inline">\(y\)</span> from <span class="math inline">\(x\)</span> goes through the points where the ellipses have vertical tangents. The <em>other</em> regression line, predicting <span class="math inline">\(x\)</span> from <span class="math inline">\(y\)</span> goes through the points of horizontal tangency.</p></li>
<li><p>The correlation <span class="math inline">\(r(x, y)\)</span> is the ratio of the vertical segment from the mean of <span class="math inline">\(y\)</span> to the regression line to the vertical segment going to the top of the ellipse as shown at the right of the figure. It is <span class="math inline">\(r = 0.46\)</span> in this example.</p></li>
<li><p>The residual standard deviation, <span class="math inline">\(s_e = \sqrt{MSE} = \sqrt{\Sigma (y - \bar{y})^2 / n-2}\)</span>, is the half-length of the ellipse at the mean <span class="math inline">\(\bar{x}\)</span></p></li>
</ul>
<p>Because Galton’s values of <code>parent</code> and <code>child</code> height were recorded in class intervals of 1 in., they are shown as sunflower symbols in <a href="#fig-galton-ellipse-r">Figure&nbsp;<span>3.10</span></a>, with multiple ‘petals’ reflecting the number of observations at each location. This plot (except for annotations) is constructed using <code><a href="https://rdrr.io/r/graphics/sunflowerplot.html">sunflowerplot()</a></code> and <code><a href="https://rdrr.io/pkg/car/man/Ellipses.html">car::dataEllipse()</a></code> for the ellipses.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Galton</span>, package <span class="op">=</span> <span class="st">"HistData"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/sunflowerplot.html">sunflowerplot</a></span><span class="op">(</span><span class="va">parent</span> <span class="op">~</span> <span class="va">child</span>, data<span class="op">=</span><span class="va">Galton</span>, </span>
<span>      xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">61</span>,<span class="fl">75</span><span class="op">)</span>, </span>
<span>      ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">61</span>,<span class="fl">75</span><span class="op">)</span>, </span>
<span>      seg.col<span class="op">=</span><span class="st">"black"</span>, </span>
<span>        xlab<span class="op">=</span><span class="st">"Child height"</span>, </span>
<span>      ylab<span class="op">=</span><span class="st">"Mid Parent height"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">parent</span> <span class="op">~</span> <span class="va">child</span>, data<span class="op">=</span><span class="va">Galton</span><span class="op">)</span>     <span class="co"># regression of y on x</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="va">y.x</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">x.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">child</span> <span class="op">~</span> <span class="va">parent</span>, data<span class="op">=</span><span class="va">Galton</span><span class="op">)</span>     <span class="co"># regression of x on y</span></span>
<span><span class="va">cc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">x.y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="op">-</span><span class="va">cc</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="va">cc</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">/</span><span class="va">cc</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">Galton</span>, </span>
<span>     <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/Ellipses.html">dataEllipse</a></span><span class="op">(</span><span class="va">child</span>, <span class="va">parent</span>, </span>
<span>         plot.points<span class="op">=</span><span class="cn">FALSE</span>, </span>
<span>         levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.40</span>, <span class="fl">0.68</span>, <span class="fl">0.95</span><span class="op">)</span>, </span>
<span>         lty<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="r-functions-for-data-ellipses" class="level4" data-number="3.1.4.2"><h4 data-number="3.1.4.2" class="anchored" data-anchor-id="r-functions-for-data-ellipses">
<span class="header-section-number">3.1.4.2</span> R functions for data ellipses</h4>
<p>A number of packages provide functions for drawing data ellipses in a scatterplot, with various features.</p>
<ul>
<li>
<code><a href="https://rdrr.io/pkg/car/man/scatterplot.html">car::scatterplot()</a></code>: uses base R graphics to draw 2D scatterplots, with a wide variety of plot enhancements including linear and non-parametric smoothers (loess, gam), a formula method, e.g., <code>y ~ x | group</code>, and marking points and lines using symbol shape, color, etc. Importantly, the <strong>car</strong> package generally allows automatic identification of “noteworthy” points by their labels in the plot using a variety of methods. For example, <code>method = "mahal"</code> labels cases with the most extreme Mahalanobis distances; <code>method = "r"</code> selects points according to their value of <code>abs(y)</code>, which is appropriate in residual plots.</li>
<li>
<code><a href="https://rdrr.io/pkg/car/man/Ellipses.html">car::dataEllipse()</a></code>: plots classical or robust data (using <code>MASS::cov/trob()</code>) ellipses for one or more groups, with the same facilities for point identification.</li>
<li>
<code><a href="https://friendly.github.io/heplots/reference/covEllipses.html">heplots::covEllipses()</a></code>: draws classical or robust data ellipses for one or more groups in a one-way design and optionally for the pooled total sample, where the focus is on homogeneity of within-group covariance matrices.</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">ggplot2::stat_ellipse()</a></code>: uses the calculation methods of <code><a href="https://rdrr.io/pkg/car/man/Ellipses.html">car::dataEllipse()</a></code> to add unfilled (<code>geom = "path"</code>) or filled (<code>geom = polygon"</code>) data ellipses in a <code>ggplot</code> scatterplot, using inherited aesthetics.</li>
</ul></section><section id="sec-prestige" class="level4 nonumber" data-number="3.1.4.3"><h4 class="nonumber anchored" data-number="3.1.4.3" data-anchor-id="sec-prestige">
<span class="header-section-number">3.1.4.3</span> Example: Canadian occupational prestige</h4>
<p>These examples use the data on the prestige of 102 occupational categories and other measures from the 1971 Canadian Census, recorded in <code><a href="https://rdrr.io/pkg/carData/man/Prestige.html">carData::Prestige</a></code>. Our interest is in understanding how <code>prestige</code> (the Pineo-Porter <span class="citation" data-cites="PineoPorter2008">(<a href="90-references.html#ref-PineoPorter2008" role="doc-biblioref">Pineo and Porter 2008</a>)</span> prestige score for an occupational category, derived from a social survey) is related to census measures of the average education, income, percent women of incumbents in those occupations. Occupation <code>type</code> is a factor with levels <code>"bc"</code> (blue collar), <code>"wc"</code> (white collar) and <code>"prof"</code> (professional).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Prestige</span>, package<span class="op">=</span><span class="st">"carData"</span><span class="op">)</span></span>
<span><span class="co"># `type` is really an ordered factor. Make it so.</span></span>
<span><span class="va">Prestige</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span><span class="va">Prestige</span><span class="op">$</span><span class="va">type</span>,</span>
<span>                         levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bc"</span>, <span class="st">"wc"</span>, <span class="st">"prof"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">Prestige</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    102 obs. of  6 variables:</span></span>
<span><span class="co">#&gt;  $ education: num  13.1 12.3 12.8 11.4 14.6 ...</span></span>
<span><span class="co">#&gt;  $ income   : int  12351 25879 9271 8865 8403 11030 8258 14163 11377 11023 ...</span></span>
<span><span class="co">#&gt;  $ women    : num  11.16 4.02 15.7 9.11 11.68 ...</span></span>
<span><span class="co">#&gt;  $ prestige : num  68.8 69.1 63.4 56.8 73.5 77.6 72.6 78.1 73.1 68.8 ...</span></span>
<span><span class="co">#&gt;  $ census   : int  1113 1130 1171 1175 2111 2113 2133 2141 2143 2153 ...</span></span>
<span><span class="co">#&gt;  $ type     : Ord.factor w/ 3 levels "bc"&lt;"wc"&lt;"prof": 3 3 3 3 3 3 3 3 3 3 ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I first illustrate the relation between <code>income</code> and <code>prestige</code> using <code><a href="https://rdrr.io/pkg/car/man/scatterplot.html">car::scatterplot()</a></code> with many of its bells and whistles, including marginal boxplots for the variables, the linear regression line, loess smooth and the 68% data ellipse.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplot.html">scatterplot</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">income</span>, data<span class="op">=</span><span class="va">Prestige</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>, cex.lab <span class="op">=</span> <span class="fl">1.25</span>,</span>
<span>  regLine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>, </span>
<span>                lty.smooth <span class="op">=</span> <span class="fl">1</span>, lwd.smooth<span class="op">=</span><span class="fl">3</span>,</span>
<span>                col.smooth <span class="op">=</span> <span class="st">"darkgreen"</span>, col.var <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span>,</span>
<span>  ellipse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fl">0.68</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">4</span>, method <span class="op">=</span> <span class="st">"mahal"</span>, col<span class="op">=</span><span class="st">"black"</span>, cex<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; general.managers          lawyers        ministers       physicians </span></span>
<span><span class="co">#&gt;                2               17               20               24</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Prestige-scatterplot-income1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Prestige-scatterplot-income1-1.png" class="img-fluid figure-img" style="width:800.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.11: Scatterplot of prestige vs.&nbsp;income, showing the linear regression line (red), the loess smooth with a confidence envelope (darkgreen) and a 68% data ellipse.</figcaption></figure>
</div>
</div>
</div>
<p>There is a lot that can be seen here:</p>
<ul>
<li>
<code>income</code> is positively skewed, as is often the case</li>
<li>the loess smooth, on the scale of income, shows <code>prestige</code> increasing up to $15,000 (these are 1971 incomes), and then leveling off.</li>
<li>the data ellipse, centered at the means encloses approximately 68% of the data points. It adds visual information about the correlation and precision of the linear regression; but here, the non-linear trend for higher incomes strongly suggests a different approach.</li>
<li>the four points identified by their labels are those with the largest Mahalanobis distances. <code><a href="https://rdrr.io/pkg/car/man/scatterplot.html">scatterplot()</a></code> prints their labels to the console.</li>
</ul>
<p><a href="#fig-Prestige-scatterplot-educ1">Figure&nbsp;<span>3.12</span></a> shows a similar plot for education, which from the boxplot appears to be reasonably symmetric. The smoothed curve is quite close to the linear regression, according to which <code>prestige</code> increases on average <code>coef(lm(prestige ~ education, data=Prestige))[2]</code> = 5.361 with each year of education.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplot.html">scatterplot</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">education</span>, data<span class="op">=</span><span class="va">Prestige</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>, cex.lab <span class="op">=</span> <span class="fl">1.25</span>,</span>
<span>  regLine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>, </span>
<span>                lty.smooth <span class="op">=</span> <span class="fl">1</span>, lwd.smooth<span class="op">=</span><span class="fl">3</span>,</span>
<span>                col.smooth <span class="op">=</span> <span class="st">"darkgreen"</span>, col.var <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span>,</span>
<span>  ellipse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fl">0.68</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">4</span>, method <span class="op">=</span> <span class="st">"mahal"</span>, col<span class="op">=</span><span class="st">"black"</span>, cex<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  physicians file.clerks    newsboys     farmers </span></span>
<span><span class="co">#&gt;          24          41          53          67</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Prestige-scatterplot-educ1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Prestige-scatterplot-educ1-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.12: Scatterplot of prestige vs.&nbsp;education, showing the linear regression line (red), the loess smooth with a confidence envelope (darkgreen) and a 68% data ellipse.</figcaption></figure>
</div>
</div>
</div>
<p>In this plot, farmers, newsboys, file.clerks and physicians are identified as noteworthy, for being furthest from the mean by Mahalanobis distance. In relation to their typical level of education, these are mostly understandable, but it is nice that farmers are rated of higher prestige than their level of education would predict.</p>
<p>Note that the <code>method</code> argument for point identification can take a vector of case numbers indicating the points to be labeled. So, to label the observations with large absolute standardized residuals in the linear model <code>m</code>, you can use <code>method = which(abs(rstandard(m)) &gt; 2)</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="fl">.1</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">education</span>, data<span class="op">=</span><span class="va">Prestige</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplot.html">scatterplot</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">education</span>, data<span class="op">=</span><span class="va">Prestige</span>,</span>
<span>            pch <span class="op">=</span> <span class="fl">16</span>, cex.lab <span class="op">=</span> <span class="fl">1.25</span>,</span>
<span>            boxplots <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>            regLine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>            smooth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>,</span>
<span>                          lty.smooth <span class="op">=</span> <span class="fl">1</span>, col.smooth <span class="op">=</span> <span class="st">"black"</span>, lwd.smooth<span class="op">=</span><span class="fl">3</span>,</span>
<span>                          col.var <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span>,</span>
<span>            ellipse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fl">0.68</span><span class="op">)</span>,</span>
<span>            id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">4</span>, method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">rstandard</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">2</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"black"</span>, cex<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;               file.clerks                collectors </span></span>
<span><span class="co">#&gt;                        41                        46 </span></span>
<span><span class="co">#&gt;                  newsboys service.station.attendant </span></span>
<span><span class="co">#&gt;                        53                        54 </span></span>
<span><span class="co">#&gt;                   farmers </span></span>
<span><span class="co">#&gt;                        67</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Prestige-scatterplot-educ2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Prestige-scatterplot-educ2-1.png" class="img-fluid figure-img" style="width:800.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.13: Scatterplot of prestige vs.&nbsp;education, labeling points whose absolute stanardized residual is &gt; 2.</figcaption></figure>
</div>
</div>
</div>
</section><section id="plotting-on-a-log-scale" class="level4" data-number="3.1.4.4"><h4 data-number="3.1.4.4" class="anchored" data-anchor-id="plotting-on-a-log-scale">
<span class="header-section-number">3.1.4.4</span> Plotting on a log scale</h4>
<p>A typical remedy for the non-linear relationship of income to prestige is to plot income on a log scale. This usually makes sense, and expresses a belief that a <strong>multiple</strong> of or <strong>percentage increase</strong> in income has a constant impact on prestige, as opposed to the <strong>additive</strong> interpretation for income itself.</p>
<p>For example, the slope of the linear regression line in <a href="#fig-Prestige-scatterplot-income1">Figure&nbsp;<span>3.11</span></a> is given by <code>coef(lm(prestige ~ income, data=Prestige))[2]</code> = 0.003. Multiplying this by 1000 says that a $1000 increase in <code>income</code> is associated with with an average increase of <code>prestige</code> of 2.9.</p>
<p>In the plot below, <code>scatterplot(..., log = "x")</code> re-scales the x-axis to the <span class="math inline">\(\log_e()\)</span> scale. The slope, <code>coef(lm(prestige ~ log(income), data=Prestige))[2]</code> = 21.556 says that a 1% increase in salary is associated with an average change of 21.55 / 100 in prestige.</p>
<div class="cell" data-layout-align="center" data-source-line-numbers="2">
<div class="sourceCode" id="cb16" data-source-line-numbers="2" data-code-line-numbers="2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplot.html">scatterplot</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">income</span>, data<span class="op">=</span><span class="va">Prestige</span>,</span>
<span>  log <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>, cex.lab <span class="op">=</span> <span class="fl">1.25</span>,</span>
<span>  regLine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>,</span>
<span>                lty.smooth <span class="op">=</span> <span class="fl">1</span>, lwd.smooth<span class="op">=</span><span class="fl">3</span>,</span>
<span>                col.smooth <span class="op">=</span> <span class="st">"darkgreen"</span>, col.var <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span>,</span>
<span>  ellipse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fl">0.68</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">4</span>, method <span class="op">=</span> <span class="st">"mahal"</span>, col<span class="op">=</span><span class="st">"black"</span>, cex<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; general.managers        ministers         newsboys      babysitters </span></span>
<span><span class="co">#&gt;                2               20               53               63</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Prestige-scatterplot2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Prestige-scatterplot2-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.14: Scatterplot of prestige vs.&nbsp;log(income).</figcaption></figure>
</div>
</div>
</div>
<p>The smoothed curve in <a href="#fig-Prestige-scatterplot2">Figure&nbsp;<span>3.14</span></a> exhibits a slight tendency to bend upwards, but a linear relation is a reasonable approximation.</p>
</section><section id="stratifying" class="level4" data-number="3.1.4.5"><h4 data-number="3.1.4.5" class="anchored" data-anchor-id="stratifying">
<span class="header-section-number">3.1.4.5</span> Stratifying</h4>
<p>Before going further, it is instructive to ask what we could see in the relationship between income and prestige if we stratified by type of occupation, fitting separate regressions and smooths for blue collar, white collar and professional incumbents in these occupations.</p>
<p>The formula <code>prestige ~ income | type</code> is a natural way to specify grouping by <code>type</code>; separate linear regressions and smooths are calculated for each group, applying the color and point shapes specified by the <code>col</code> and <code>pch</code> arguments.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplot.html">scatterplot</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">income</span> <span class="op">|</span> <span class="va">type</span>, data<span class="op">=</span><span class="va">Prestige</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"darkgreen"</span><span class="op">)</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">15</span><span class="op">:</span><span class="fl">17</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>coords<span class="op">=</span><span class="st">"bottomright"</span><span class="op">)</span>,</span>
<span>  regLine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  smooth<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>, </span>
<span>              var<span class="op">=</span><span class="cn">FALSE</span>, lwd.smooth<span class="op">=</span><span class="fl">2</span>, lty.smooth<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Prestige-scatterplot3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-Prestige-scatterplot3-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.15: Scatterplot of prestige vs.&nbsp;income, stratified by occupational type. This implies a different interpretation, where occupation type is a moderator variable.</figcaption></figure>
</div>
</div>
</div>
<p>This visual analysis offers a different interpretation of the dependence of prestige on income, which appeared to be non-linear when occupation type was ignored. Instead, <a href="#fig-Prestige-scatterplot3">Figure&nbsp;<span>3.15</span></a> suggests an interaction of income by type. In a model formula this would be expressed as one of:</p>
<div class="sourceCode" id="cb18" data-code-line-numbers=""><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">income</span> <span class="op">+</span> <span class="va">type</span> <span class="op">+</span> <span class="va">income</span><span class="op">:</span><span class="va">type</span>, data <span class="op">=</span> <span class="va">Prestige</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">prestige</span> <span class="op">~</span> <span class="va">income</span> <span class="op">*</span> <span class="va">type</span>, data <span class="op">=</span> <span class="va">Prestige</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These models signify that there are different slopes (and intercepts) for the three occupational types. In this interpretation, <code>type</code> is a moderator variable, with a different story. The slopes of the fitted lines suggest that among blue collar workers, prestige increases sharply with their income. For white collar and professional workers, there is still an increasing relation of prestige with income, but the effect of income (slope) diminishes with higher occupational category. A different plot entails a different story.</p>
</section><section id="sec-penguins" class="level4 nonumber" data-number="3.1.4.6"><h4 class="nonumber anchored" data-number="3.1.4.6" data-anchor-id="sec-penguins">
<span class="header-section-number">3.1.4.6</span> Example: Penguins data</h4>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-penguin-species" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="images/penguin-species.jpg" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.16: Penguin species observed in the Palmer Archipelago</figcaption></figure>
</div>
</div>
</div>
<p>The <code>penguins</code> dataset from the <strong>palmerpenguins</strong> package <span class="citation" data-cites="R-palmerpenguins">(<a href="90-references.html#ref-R-palmerpenguins" role="doc-biblioref">Horst, Hill, and Gorman 2022</a>)</span> provides further instructive examples of plots and analyses of multivariate data. The data consists of measurements of body size (flipper length, body mass, bill length and depth) of 344 penguins collected at the <a href="https://pallter.marine.rutgers.edu/">Palmer Research Station</a> in Antartica. There were three different species of penguins (Adélie, Chinstrap &amp; Gentoo) collected from 3 islands in the Palmer Archipelago between 2007–2009 <span class="citation" data-cites="Gorman2014">(<a href="90-references.html#ref-Gorman2014" role="doc-biblioref">Gorman, Williams, and Fraser 2014</a>)</span>. The purpose was to examine differences in size or appearance of these species, particularly differences among the sexes (sexual dimorphism) in relation to foraging and habitat.</p>
<p>Here I use a slightly altered version of the dataset, <code>peng</code>, renaming variables to remove the units, making factors of character variables and deleting a few cases with missing data.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">penguins</span>, package <span class="op">=</span> <span class="st">"palmerpenguins"</span><span class="op">)</span></span>
<span><span class="va">peng</span> <span class="op">&lt;-</span> <span class="va">penguins</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span></span>
<span>    bill_length <span class="op">=</span> <span class="va">bill_length_mm</span>, </span>
<span>    bill_depth <span class="op">=</span> <span class="va">bill_depth_mm</span>, </span>
<span>    flipper_length <span class="op">=</span> <span class="va">flipper_length_mm</span>, </span>
<span>    body_mass <span class="op">=</span> <span class="va">body_mass_g</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,</span>
<span>         island <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">island</span><span class="op">)</span>,</span>
<span>         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">sex</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">peng</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [333 × 8] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ species       : Factor w/ 3 levels "Adelie","Chinstrap",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ island        : Factor w/ 3 levels "Biscoe","Dream",..: 3 3 3 3 3 3 3 3 3 3 ...</span></span>
<span><span class="co">#&gt;  $ bill_length   : num [1:333] 39.1 39.5 40.3 36.7 39.3 38.9 39.2 41.1 38.6 34.6 ...</span></span>
<span><span class="co">#&gt;  $ bill_depth    : num [1:333] 18.7 17.4 18 19.3 20.6 17.8 19.6 17.6 21.2 21.1 ...</span></span>
<span><span class="co">#&gt;  $ flipper_length: int [1:333] 181 186 195 193 190 181 195 182 191 198 ...</span></span>
<span><span class="co">#&gt;  $ body_mass     : int [1:333] 3750 3800 3250 3450 3650 3625 4675 3200 3800 4400 ...</span></span>
<span><span class="co">#&gt;  $ sex           : Factor w/ 2 levels "f","m": 2 1 1 1 2 1 2 1 2 2 ...</span></span>
<span><span class="co">#&gt;  $ year          : int [1:333] 2007 2007 2007 2007 2007 2007 2007 2007 2007 2007 ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are quite a few variables to choose for illustrating data ellipses in scatterplots. Here I focus on the measures of their bills, <code>bill_length</code> and <code>bill_depth</code> (indicating curvature) and show how to use <code>ggplot2</code> for these plots.</p>
<p>An initial plot using <code>ggplot2</code> shown in <a href="#fig-peng-ggplot1">Figure&nbsp;<span>3.17</span></a> uses color and point shape to distinguish the three penguin species. I annotate the plot of points using the linear regression lines, loess smooths to check for non-linearity and 95% data ellipses to show precision of the linear relation.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb20" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">peng</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length</span>, y <span class="op">=</span> <span class="va">bill_depth</span>,</span>
<span>           color <span class="op">=</span> <span class="va">species</span>, shape <span class="op">=</span> <span class="va">species</span>, fill<span class="op">=</span><span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>              se<span class="op">=</span><span class="cn">FALSE</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>,  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">1.5</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"polygon"</span>, level <span class="op">=</span> <span class="fl">0.95</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.85</span>, <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-peng-ggplot1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-peng-ggplot1-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.17: Penguin bill length and bill depth according to species.</figcaption></figure>
</div>
</div>
</div>
<p>Overall, the three species occupy different regions of this 2D space and for each species the relation between bill length and depth appears reasonably linear. Given this, we can suppress plotting the data points to get a visual summary of the data using the fitted regression lines and data ellipses, as shown in <a href="#fig-peng-ggplot2">Figure&nbsp;<span>3.18</span></a>.</p>
<p>This idea, of <strong>visual thinning</strong> a graph to focus on what should be seen, becomes increasingly useful as the data becomes more complex. The <code>ggplot2</code> framework encourages this, because we can think of various components as layers, to be included or not. Here I chose to include only the regression line and add data ellipses of 40%, 68% and 95% coverage to highlight the increasing bivariate density around the group means.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">peng</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length</span>, y <span class="op">=</span> <span class="va">bill_depth</span>,</span>
<span>           color <span class="op">=</span> <span class="va">species</span>, shape <span class="op">=</span> <span class="va">species</span>, fill<span class="op">=</span><span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>,  se<span class="op">=</span><span class="cn">FALSE</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"polygon"</span>, level <span class="op">=</span> <span class="fl">0.95</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"polygon"</span>, level <span class="op">=</span> <span class="fl">0.68</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"polygon"</span>, level <span class="op">=</span> <span class="fl">0.40</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.85</span>, <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-peng-ggplot2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-peng-ggplot2-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.18: <strong>Visual thinning</strong>: Suppressing the data points gives a visual summary of the relation between bill length and bill depth using the regression line and data ellipses.</figcaption></figure>
</div>
</div>
</div>
<p>While I emphasize data ellipses (because I like their beautiful geometry), other visual summaries of the bivariate density are possible and often useful.</p>
<p>For a single variable, <code><a href="https://rdrr.io/r/stats/density.html">stats::density()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">ggplot2::geom_density()</a></code> calculate a smoothed estimate of the density using nonparametric kernel methods <span class="citation" data-cites="Silverman:86">(<a href="90-references.html#ref-Silverman:86" role="doc-biblioref">Silverman 1986</a>)</span> whose smoothness is controlled by a bandwidth parameter, analogous to the span in a loess smoother. This idea extends to two (and more) variables <span class="citation" data-cites="Scott1992">(<a href="90-references.html#ref-Scott1992" role="doc-biblioref">Scott 1992</a>)</span>. For bivariate data, <code><a href="https://rdrr.io/pkg/MASS/man/kde2d.html">MASS::kde2d()</a></code> estimates the density on a square <span class="math inline">\(n \times n\)</span> grid over the ranges of the variables.</p>
<p><code>ggplot2</code> provides <code><a href="https://ggplot2.tidyverse.org/reference/geom_density_2d.html">geom_density_2d()</a></code> which uses <code><a href="https://rdrr.io/pkg/MASS/man/kde2d.html">MASS::kde2d()</a></code> and displays these as contours— horizontal slices of the 3D surface at equally-spaced heights and projects these onto the 2D plane. The <strong>ggdensity</strong> package <span class="citation" data-cites="R-ggdensity">(<a href="90-references.html#ref-R-ggdensity" role="doc-biblioref">Otto and Kahle 2023</a>)</span> extends this with <code><a href="https://jamesotto852.github.io/ggdensity/reference/geom_hdr.html">geom_hdr()</a></code>, computing the high density regions that bound given levels of probability and maps these to the <code>alpha</code> transparency aesthetic. A <code>method</code> argument allows you to specify various nonparametric (<code>method ="kde"</code> is the default) and parametric (<code>method ="mvnorm"</code> gives normal data ellipses) ways to estimate the underlying bivariate distribution.</p>
<p><a href="#fig-peng-ggdensity">Figure&nbsp;<span>3.19</span></a> shows these side-by-side for comparison. With <code><a href="https://ggplot2.tidyverse.org/reference/geom_density_2d.html">geom_density_2d()</a></code> you can specify either the number of contour <code>bins</code> or the width of these bins (<code>binwidth</code>). For <code><a href="https://jamesotto852.github.io/ggdensity/reference/geom_hdr.html">geom_hdr()</a></code>, the <code>probs</code> argument gives a result that is easier to understand.</p>
<div class="cell" data-layout-align="center">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jamesotto852.github.io/ggdensity/">ggdensity</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">peng</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length</span>, y <span class="op">=</span> <span class="va">bill_depth</span>,</span>
<span>           color <span class="op">=</span> <span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>,  se<span class="op">=</span><span class="cn">FALSE</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density_2d.html">geom_density_2d</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span>, bins <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"geom_density_2d"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.85</span>, <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">peng</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bill_length</span>, y <span class="op">=</span> <span class="va">bill_depth</span>,</span>
<span>           color <span class="op">=</span> <span class="va">species</span>, fill <span class="op">=</span> <span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>,  se<span class="op">=</span><span class="cn">FALSE</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://jamesotto852.github.io/ggdensity/reference/geom_hdr.html">geom_hdr</a></span><span class="op">(</span>probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.68</span>, <span class="fl">0.4</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"ggdensity::geom_hdr"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.85</span>, <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-peng-ggdensity" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-peng-ggdensity-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.19: <strong>Bivariate densities</strong> show the contours of the 3D surface representing the frequency in the joint distribution of bill length and bill depth.</figcaption></figure>
</div>
</div>
</div>
</section></section></section><section id="sec-scatmat" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="sec-scatmat">
<span class="header-section-number">3.2</span> Scatterplot matrices</h2>
<p>Going beyond bivariate scatterplots, a <em>pairs</em> plot (or <em>scatterplot matrix</em>) displays all possible <span class="math inline">\(p \times p\)</span> pairs of <span class="math inline">\(p\)</span> variables in a matrix-like display where variables <span class="math inline">\((x_i, x_j)\)</span> are shown in a plot for row <span class="math inline">\(i\)</span>, column <span class="math inline">\(j\)</span>. This idea, due to <span class="citation" data-cites="Hartigan:75b">Hartigan (<a href="90-references.html#ref-Hartigan:75b" role="doc-biblioref">1975</a>)</span>, uses small multiple plots, so that the eye can easily scan across a row or down a column to see how a given variable is related to all the others.</p>
<p>The most basic version is provided by <code><a href="https://rdrr.io/r/graphics/pairs.html">pairs()</a></code> in base R. When one variable is considered as an outcome or response, it is usually helpful to put this in the first row and column. For the <code>Prestige</code> data, in addition to income and education, we also have a measure of % women in each occupational category. Plotting these together gives <a href="#fig-prestige-pairs">Figure&nbsp;<span>3.20</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="op">~</span> <span class="va">prestige</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">women</span>,</span>
<span>      data<span class="op">=</span><span class="va">Prestige</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-prestige-pairs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-prestige-pairs-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.20: Scatterplot matrix of the variables in the Prestige dataset produced by <code><a href="https://rdrr.io/r/graphics/pairs.html">pairs()</a></code></figcaption></figure>
</div>
</div>
</div>
<p>The plots in the first row show what we have seen before for the relations between prestige and income and education, adding to those the plot of prestige vs.&nbsp;% women. Plots in the first column show the same data, but with <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> interchanged.</p>
<p>A more feature-rich version is provided by <code><a href="https://rdrr.io/pkg/car/man/scatterplotMatrix.html">car::scatterplotMatrix()</a></code> which can add the regression lines, loess smooths and data ellipses for each pair. The diagonal panels show density curves for the distribution of each variable; for example, the distribution of education appears to be multi-modal and that of <code>women</code> shows that most of the occupations have a low percentage of women. The combination of the regression line with the loess smoothed curve, but without their confidence envelopes, provides about the right amount of detail to take in at a glance where the relations are non-linear.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplotMatrix.html">scatterplotMatrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">prestige</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">women</span>,</span>
<span>  data<span class="op">=</span><span class="va">Prestige</span>,</span>
<span>  regLine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>method<span class="op">=</span><span class="va">lm</span>, lty<span class="op">=</span><span class="fl">1</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span>,</span>
<span>  smooth<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>, spread<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>              lty.smooth<span class="op">=</span><span class="fl">1</span>, lwd.smooth<span class="op">=</span><span class="fl">3</span>, col.smooth<span class="op">=</span><span class="st">"red"</span><span class="op">)</span>,</span>
<span>  ellipse<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>levels<span class="op">=</span><span class="fl">0.68</span>, fill.alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-prestige-spm1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-prestige-spm1-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.21: Scatterplot matrix of the variables in the Prestige dataset from <code><a href="https://rdrr.io/pkg/car/man/scatterplotMatrix.html">car::scatterplotMatrix()</a></code>.</figcaption></figure>
</div>
</div>
</div>
<p><code><a href="https://rdrr.io/pkg/car/man/scatterplotMatrix.html">scatterplotMatrix()</a></code> can also label points using the <code>id =</code> argument (though this can get messy) and can stratify the observations by a grouping variable with different symbols and colors. For example <a href="#fig-prestige-spm2">Figure&nbsp;<span>3.22</span></a> uses the syntax <code>~ prestige + education + income + women | type</code> to provide separate regression lines, smoothed curves and data ellipses for the three types of occupations. (The default colors are somewhat garish, so I use <code><a href="https://scales.r-lib.org/reference/hue_pal.html">scales::hue_pal()</a></code> to mimic the discrete color scale used in <code>ggplot2</code>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/scatterplotMatrix.html">scatterplotMatrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">prestige</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">women</span> <span class="op">|</span> <span class="va">type</span>,</span>
<span>  data <span class="op">=</span> <span class="va">Prestige</span>,</span>
<span>  col <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/hue_pal.html">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">15</span><span class="op">:</span><span class="fl">17</span>,</span>
<span>  smooth<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>smoother<span class="op">=</span><span class="va">loessLine</span>, spread<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>              lty.smooth<span class="op">=</span><span class="fl">1</span>, lwd.smooth<span class="op">=</span><span class="fl">3</span>, col.smooth<span class="op">=</span><span class="st">"black"</span><span class="op">)</span>,</span>
<span>  ellipse<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>levels<span class="op">=</span><span class="fl">0.68</span>, fill.alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-prestige-spm2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="figs/fig-prestige-spm2-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3.22: Scatterplot matrix of the variables in the Prestige dataset from <code><a href="https://rdrr.io/pkg/car/man/scatterplotMatrix.html">car::scatterplotMatrix()</a></code>, stratified by type of occupation.</figcaption></figure>
</div>
</div>
</div>
<p>It is now easy to see why education is multi-modal: blue collar, white collar and professional occupations have largely non-overlapping years of education. As well, the distribution of % women is much higher in the white collar category.</p>
<section id="generalized-pairs-plots" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="generalized-pairs-plots">
<span class="header-section-number">3.2.1</span> Generalized pairs plots</h3>
<p>When a dataset contains one or more discrete variables, the traditional pairs plot provides cannot cope, using only color and/or point symbols to represent categorical variables. In the context of mosaic displays and loglinear models, representing <span class="math inline">\(n\)</span>-way frequency tables by rectangular tiles depicting cell frequencies, I <span class="citation" data-cites="Friendly:94a">(<a href="90-references.html#ref-Friendly:94a" role="doc-biblioref">Friendly 1994</a>)</span> proposed an analog of the scatterplot matrix using mosaic plots for each pair of variables. The <strong>vcd</strong> package <span class="citation" data-cites="R-vcd">(<a href="90-references.html#ref-R-vcd" role="doc-biblioref">Meyer, Zeileis, and Hornik 2023</a>)</span> implements very general <code><a href="https://rdrr.io/r/graphics/pairs.html">pairs()</a></code> methods for <code>"table"</code> objects. See my book <em>Discrete Data Analysis with R</em> <span class="citation" data-cites="FriendlyMeyer:2016:DDAR">(<a href="90-references.html#ref-FriendlyMeyer:2016:DDAR" role="doc-biblioref">Friendly and Meyer 2016</a>)</span> …</p>
<p>The next step, by John Emerson and others <span class="citation" data-cites="Emerson-etal:2013">(<a href="90-references.html#ref-Emerson-etal:2013" role="doc-biblioref">Emerson et al. 2013</a>)</span> was to recognize that combinations of continuous and discrete, categorical variables could be plotted in different ways.</p>
<ul>
<li>two continuous variables can be shown as a standard scatterplot of points and/or bivariate density contours, or simply by numeric summaries such as a correlation value;</li>
<li>a pair of one continuous and one categorical variable can be shown as side-by-side boxplots or violin plots, histograms or density plots</li>
<li>two categorical variables could be shown in a mosaic plot or by grouped bar plots.</li>
</ul>
<p>In the <code>ggplot2</code> framework, these displays are implemented in the <strong>GGally</strong> package <span class="citation" data-cites="R-GGally">(<a href="90-references.html#ref-R-GGally" role="doc-biblioref">Schloerke et al. 2021</a>)</span> …</p>
</section></section><section id="sec-parcoord" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sec-parcoord">
<span class="header-section-number">3.3</span> Parallel coordinate plots</h2>
<!-- ## Categorical data: -->
<!--     + mosaic plots -->
<!-- ## Generalized pair plots -->
<div class="cell" data-layout-align="center">
<pre data-code-line-numbers=""><code>#&gt; 16  packages used here:
#&gt;  base, car, carData, corrgram, datasets, dplyr, GGally, ggdensity, ggplot2, graphics, grDevices, methods, patchwork, stats, tidyr, utils</code></pre>
</div>
<!-- ## References {.unnumbered} -->


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Becker:1996:VDC" class="csl-entry" role="listitem">
Becker, R. A., W. S. Cleveland, and M.-J. Shyu. 1996. <span>“The Visual Design and Control of Trellis Display.”</span> <em>Journal of Computational and Graphical Statistics</em> 5 (2): 123–55.
</div>
<div id="ref-ChambersHastie1991" class="csl-entry" role="listitem">
Chambers, John M., and Trevor J. Hastie. 1991. <em>Statistical Models in s</em>. Chapman &amp; Hall/CRC.
</div>
<div id="ref-Cleveland:79" class="csl-entry" role="listitem">
Cleveland, W. S. 1979. <span>“Robust Locally Weighted Regression and Smoothing Scatterplots.”</span> <em>Journal of the American Statistical Association</em> 74: 829–36.
</div>
<div id="ref-ClevelandDevlin:88" class="csl-entry" role="listitem">
Cleveland, W. S., and S. J. Devlin. 1988. <span>“Locally Weighted Regression: An Approach to Regression Analysis by Local Fitting.”</span> <em>Journal of the American Statistical Association</em> 83: 596–610.
</div>
<div id="ref-ClevelandMcGill:84b" class="csl-entry" role="listitem">
Cleveland, W. S., and R. McGill. 1984. <span>“Graphical Perception: Theory, Experimentation and Application to the Development of Graphical Methods.”</span> <em>Journal of the American Statistical Association</em> 79: 531–54.
</div>
<div id="ref-ClevelandMcGill:85" class="csl-entry" role="listitem">
———. 1985. <span>“Graphical Perception and Graphical Methods for Analyzing Scientific Data.”</span> <em>Science</em> 229: 828–33.
</div>
<div id="ref-Dempster:69" class="csl-entry" role="listitem">
Dempster, A. P. 1969. <em>Elements of Continuous Multivariate Analysis</em>. Reading, MA: Addison-Wesley.
</div>
<div id="ref-Emerson-etal:2013" class="csl-entry" role="listitem">
Emerson, John W., Walton A. Green, Barret Schloerke, Jason Crowley, Dianne Cook, Heike Hofmann, and Hadley Wickham. 2013. <span>“The Generalized Pairs Plot.”</span> <em>Journal of Computational and Graphical Statistics</em> 22 (1): 79–91. <a href="http://www.tandfonline.com/doi/ref/10.1080/10618600.2012.694762">http://www.tandfonline.com/doi/ref/10.1080/10618600.2012.694762</a>.
</div>
<div id="ref-Fox:2016:ARA" class="csl-entry" role="listitem">
Fox, John. 2016. <em>Applied Regression Analysis and Generalized Linear Models</em>. Third edition. Los Angeles: SAGE.
</div>
<div id="ref-Friendly:94a" class="csl-entry" role="listitem">
Friendly, Michael. 1994. <span>“Mosaic Displays for Multi-Way Contingency Tables.”</span> <em>Journal of the American Statistical Association</em> 89: 190–200. <a href="http://www.jstor.org/stable/2291215">http://www.jstor.org/stable/2291215</a>.
</div>
<div id="ref-FriendlyMeyer:2016:DDAR" class="csl-entry" role="listitem">
Friendly, Michael, and David Meyer. 2016. <em>Discrete Data Analysis with <span>R</span>: Visualization and Modeling Techniques for Categorical and Count Data</em>. Boca Raton, FL: Chapman &amp; Hall/CRC.
</div>
<div id="ref-Friendly-etal:ellipses:2013" class="csl-entry" role="listitem">
Friendly, Michael, Georges Monette, and John Fox. 2013. <span>“Elliptical Insights: Understanding Statistical Methods Through Elliptical Geometry.”</span> <em>Statistical Science</em> 28 (1): 1–39. <a href="https://doi.org/10.1214/12-STS402">https://doi.org/10.1214/12-STS402</a>.
</div>
<div id="ref-Galton:1886" class="csl-entry" role="listitem">
Galton, Francis. 1886. <span>“Regression Towards Mediocrity in Hereditary Stature.”</span> <em>Journal of the Anthropological Institute</em> 15: 246–63. <a href="http://www.jstor.org/cgi-bin/jstor/viewitem/09595295/dm995266/99p0374f/0">http://www.jstor.org/cgi-bin/jstor/viewitem/09595295/dm995266/99p0374f/0</a>.
</div>
<div id="ref-Gorman2014" class="csl-entry" role="listitem">
Gorman, Kristen B., Tony D. Williams, and William R. Fraser. 2014. <span>“Ecological Sexual Dimorphism and Environmental Variability Within a Community of Antarctic Penguins (Genus Pygoscelis).”</span> Edited by André Chiaradia. <em><span>PLoS</span> <span>ONE</span></em> 9 (3): e90081. <a href="https://doi.org/10.1371/journal.pone.0090081">https://doi.org/10.1371/journal.pone.0090081</a>.
</div>
<div id="ref-Hartigan:75b" class="csl-entry" role="listitem">
Hartigan, J. A. 1975. <span>“Printer Graphics for Clustering.”</span> <em>Journal of Statistical Computing and Simulation</em> 4: 187–213.
</div>
<div id="ref-R-palmerpenguins" class="csl-entry" role="listitem">
Horst, Allison, Alison Hill, and Kristen Gorman. 2022. <em>Palmerpenguins: Palmer Archipelago (Antarctica) Penguin Data</em>. <a href="https://allisonhorst.github.io/palmerpenguins/">https://allisonhorst.github.io/palmerpenguins/</a>.
</div>
<div id="ref-R-vcd" class="csl-entry" role="listitem">
Meyer, David, Achim Zeileis, and Kurt Hornik. 2023. <em>Vcd: Visualizing Categorical Data</em>. <a href="https://CRAN.R-project.org/package=vcd">https://CRAN.R-project.org/package=vcd</a>.
</div>
<div id="ref-Monette:90" class="csl-entry" role="listitem">
Monette, Georges. 1990. <span>“Geometry of Multiple Regression and Interactive 3-<span>D</span> Graphics.”</span> In <em>Modern Methods of Data Analysis</em>, edited by J. Fox and S. Long, 209–56. Beverly Hills, CA: SAGE Publications.
</div>
<div id="ref-R-ggdensity" class="csl-entry" role="listitem">
Otto, James, and David Kahle. 2023. <em>Ggdensity: Interpretable Bivariate Density Visualization with Ggplot2</em>. <a href="https://jamesotto852.github.io/ggdensity/">https://jamesotto852.github.io/ggdensity/</a>.
</div>
<div id="ref-PineoPorter2008" class="csl-entry" role="listitem">
Pineo, Peter O., and John Porter. 2008. <span>“Occupational Prestige in Canada.”</span> <em>Canadian Review of Sociology</em> 4 (1): 24–40. <a href="https://doi.org/10.1111/j.1755-618x.1967.tb00472.x">https://doi.org/10.1111/j.1755-618x.1967.tb00472.x</a>.
</div>
<div id="ref-R-lattice" class="csl-entry" role="listitem">
Sarkar, Deepayan. 2023. <em>Lattice: Trellis Graphics for r</em>. <a href="https://lattice.r-forge.r-project.org/">https://lattice.r-forge.r-project.org/</a>.
</div>
<div id="ref-R-GGally" class="csl-entry" role="listitem">
Schloerke, Barret, Di Cook, Joseph Larmarange, Francois Briatte, Moritz Marbach, Edwin Thoen, Amos Elberg, and Jason Crowley. 2021. <em>GGally: Extension to Ggplot2</em>. <a href="https://ggobi.github.io/ggally/">https://ggobi.github.io/ggally/</a>.
</div>
<div id="ref-Scott1992" class="csl-entry" role="listitem">
Scott, David W. 1992. <em>Multivariate Density Estimation: Theory, Practice, and Visualization</em>. A Wiley-Interscience Publication. NY: Wiley.
</div>
<div id="ref-Silverman:86" class="csl-entry" role="listitem">
Silverman, B. W. 1986. <em>Density Estimation for Statistics and Data Analysis</em>. New York: Chapman &amp; Hall.
</div>
<div id="ref-Wood:2006" class="csl-entry" role="listitem">
Wood, Simon N. 2006. <em>Generalized Additive Models: An Introduction with r</em>. Chapman; Hall/CRC Press.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>The classic study by <span class="citation" data-cites="ClevelandMcGill:84b">Cleveland and McGill (<a href="90-references.html#ref-ClevelandMcGill:84b" role="doc-biblioref">1984</a>)</span>;<span class="citation" data-cites="ClevelandMcGill:85">Cleveland and McGill (<a href="90-references.html#ref-ClevelandMcGill:85" role="doc-biblioref">1985</a>)</span> shows that judgements of magnitude along a common scale are more accurate than those along separate, aligned scales.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./02-getting_started.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting Started</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04-pca-biplot.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">PCA and Biplots</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>