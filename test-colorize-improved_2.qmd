---
title: "Test colorize2 - Luminance-based coloring"
author: "Michael Friendly"
date: today
format:
  html:
    html-math-method: mathjax
    theme:
      - styles.scss
  pdf:
    documentclass: krantz
    classoption: [10pt, krantz2, titlepage, letterpaper]
    include-in-header: latex/preamble.tex
    keep-tex: true
    latex-tinytex: true
---

```{r include=FALSE}
source("R/common.R")
knitr::opts_chunk$set(error = TRUE)
```

## Printing text in color in HTML and LaTeX

When I refer to colors, I want to print their names in their actual color. But if the color is light, it doesn't show up well on
a white background. Alternatively I could color the background, but if the color is dark, black text for the color name doesn't
show up well. 

```{r test-colors}
test_colors <- c("red", "blue", "green",
                 "white", "black", "gray",
                 "pink", "yellow", "darkgreen",
                 "orange", "purple")
```

RStudio does a reasonable job of this in editor windows, using various shades of gray for the text on a colored background
of the named color. Here's what this looks like:

![test-colors](images/test_colors.png)


How can I achieve this in a Quarto document to be rendered in either HTML or PDF?

### Using `colorize()` - Original approach

Define a function to print `text` in `color`. If `color` is missing, assume `text` is the color.
```{r colorize}
colorize <- function(text, color) {
  if (missing(color)) color <- text
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, text)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, text)
  } else text      # Fallback for other formats
}
```

Try it:

`r colorize("Gentoo", "orange")` and  `r colorize("Adelie", "purple")` and  `r colorize("Chinstrap", "darkgreen")` are Penguins.

This plot has `r colorize("red")` points, `r colorize("blue")` points, `r colorize("green")` points, which are nice.
Other colors used in the plot are `r colorize("yellow")`, `r colorize("pink")`, `r colorize("gray")` and `r colorize("black")`.

As you can see, `r colorize("yellow")` and `r colorize("pink")` are illegible.

### Using `colorize_bg()` - Background approach

Define a function to print text with background color:

```{r colorize-bg}
colorize_bg <- function(text, bgcolor) {
  if (missing(bgcolor)) bgcolor <- text
  if (knitr::is_latex_output()) {
    sprintf("\\colorbox{%s}{%s}", bgcolor, text)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='background-color: %s;'>%s</span>", bgcolor, text)
  } else {
    text # Fallback for other formats
  }
}
```

Try it:

`r colorize_bg("Gentoo", "orange")` and  `r colorize_bg("Adelie", "purple")` and  `r colorize_bg("Chinstrap", "darkgreen")` are Penguins.

This plot has `r colorize_bg("red")` points, `r colorize_bg("blue")` points, `r colorize_bg("green")` points, which are nice.
Other colors used in the plot are `r colorize_bg("yellow")`, `r colorize_bg("pink")`, `r colorize_bg("gray")` and `r colorize_bg("black")`.

As you can see, `r colorize_bg("blue")` and `r colorize_bg("black")` are illegible.

## Solution: `colorize2()` with luminance-based text color

The key is to calculate the luminance of the background color and choose an appropriate gray shade for the text.
I'll use relative luminance (similar to WCAG standards) to determine if a color is "light" or "dark".

```{r colorize2}
library(colorspace)

colorize2 <- function(text, color) {
  if (missing(color)) color <- text
  # grey -> gray, because xcolor doesn't recognize this
  if (color == "grey") color <- "gray"
  
  # Convert color to RGB and then to relative luminance
  # Using sRGB color space for accurate luminance calculation
  rgb_vals <- col2rgb(color)[, 1] / 255
  
  # Apply gamma correction for sRGB
  rgb_linear <- ifelse(rgb_vals <= 0.03928,
                       rgb_vals / 12.92,
                       ((rgb_vals + 0.055) / 1.055)^2.4)
  
  # Calculate relative luminance (ITU-R BT.709)
  luminance <- 0.2126 * rgb_linear[1] + 
               0.7152 * rgb_linear[2] + 
               0.0722 * rgb_linear[3]
  
  # Choose text color based on luminance
  # Adjusted thresholds for better contrast
  # LaTeX uses black!X notation where X is percentage of black (0-100)
  if (luminance > 0.65) {
    # Very light backgrounds: use very dark gray
    text_color_latex <- "black!90"  # 90% black
    text_color_html <- "#1a1a1a"
  } else if (luminance > 0.45) {
    # Light-medium backgrounds: use dark gray  
    text_color_latex <- "black!80"  # 80% black
    text_color_html <- "#333333"
  } else if (luminance > 0.25) {
    # Medium-dark backgrounds: use light gray
    text_color_latex <- "black!20"  # 20% black (80% white)
    text_color_html <- "#cccccc"
  } else {
    # Very dark backgrounds: use very light gray
    text_color_latex <- "black!10"  # 10% black (90% white)
    text_color_html <- "#e6e6e6"
  }
  
  # Generate output based on format
  if (knitr::is_latex_output()) {
    sprintf("\\colorbox{%s}{\\textcolor{%s}{%s}}", color, text_color_latex, text)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='background-color: %s; color: %s;'>%s</span>", 
            color, text_color_html, text)
  } else {
    text  # Fallback for other formats
  }
}
```

### Test `colorize2()` with all colors

Let's try the new function with all test colors:

`r colorize2("Gentoo", "orange")` and  `r colorize2("Adelie", "purple")` and  `r colorize2("Chinstrap", "darkgreen")` are Penguins.

This plot has `r colorize2("red")` points, `r colorize2("blue")` points, `r colorize2("green")` points, which are nice.
Other colors used in the plot are `r colorize2("yellow")`, `r colorize2("pink")`, `r colorize2("gray")`, `r colorize2("white")` and `r colorize2("black")`.

All colors should now be legible!

### Diagnostic: Show luminance values

Let's see the calculated luminance for each test color:

```{r luminance-check}
library(colorspace)

# Function to calculate luminance
get_luminance <- function(color) {
  rgb_vals <- col2rgb(color)[, 1] / 255
  rgb_linear <- ifelse(rgb_vals <= 0.03928,
                       rgb_vals / 12.92,
                       ((rgb_vals + 0.055) / 1.055)^2.4)
  luminance <- 0.2126 * rgb_linear[1] + 
               0.7152 * rgb_linear[2] + 
               0.0722 * rgb_linear[3]
  return(luminance)
}

# Calculate luminance for all test colors
luminance_df <- data.frame(
  color = test_colors,
  luminance = round(sapply(test_colors, get_luminance), 3),
  text_color_html = sapply(test_colors, function(col) {
    lum <- get_luminance(col)
    if (lum > 0.65) "#1a1a1a"
    else if (lum > 0.45) "#333333"
    else if (lum > 0.25) "#cccccc"
    else "#e6e6e6"
  }),
  text_color_latex = sapply(test_colors, function(col) {
    lum <- get_luminance(col)
    if (lum > 0.65) "black!90"
    else if (lum > 0.45) "black!80"
    else if (lum > 0.25) "black!20"
    else "black!10"
  })
)

print(luminance_df)
```

### Complete test of all colors

Here's a comprehensive test showing all colors with their appropriate contrast:

```{r results='asis', echo=FALSE}
cat("Colors: ", 
    paste(sapply(test_colors, colorize2), collapse = ", "))
```

